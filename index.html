<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naver Webtoon AI Picker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2ba85b',
                        'primary-light': '#36c66d',
                        'primary-dark': '#218a4a',
                        'bg-light': '#0B0F1A',
                        'bg-card': '#161B28',
                        'bg-card-hover': '#1E2533',
                        'border-light': 'rgba(255, 255, 255, 0.08)'
                    },
                    boxShadow: {
                        'soft': '0 10px 40px rgba(0,0,0,0.4)',
                        'glow': '0 0 30px rgba(0, 213, 100, 0.3)',
                        'glow-lg': '0 0 50px rgba(0, 213, 100, 0.5)'
                    }
                }
            }
        }
    </script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #0B0F1A;
            color: #F8FAFC;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0B0F1A;
        }

        ::-webkit-scrollbar-thumb {
            background: #2D3748;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00D564;
        }

        #root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100000;
            background: rgba(11, 15, 26, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        main {
            margin-top: 80px;
            flex: 1;
            width: 100%;
            padding-bottom: 80px;
        }

        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 150000;
            display: flex;
            justify-content: center;
            align-items: start;
            padding-top: 2vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            overflow-y: auto;
        }

        .modal-content-box {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .animate-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(0, 213, 100, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(0, 213, 100, 0.5);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .backdrop-blur-custom {
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        .modal-open {
            overflow: hidden !important;
        }

        /* Card Hover Effect */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #161B28;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .card-hover:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: #00D564;
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #00D564 0%, #00B856 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Primary Gradient Button */
        .btn-gradient {
            background: linear-gradient(135deg, #00D564 0%, #00B856 100%);
            box-shadow: 0 4px 15px rgba(0, 213, 100, 0.3);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 213, 100, 0.4);
        }

        /* Hero Covers */
        .hero-cover {
            position: absolute;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            transition: all 0.4s ease;
        }

        .hero-cover:hover {
            transform: scale(1.05) rotate(-2deg);
        }

        /* Hero Gradient Overlay */
        .hero-gradient {
            background: linear-gradient(135deg, rgba(0, 213, 100, 0.1) 0%, transparent 50%);
        }

        @keyframes blink {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.03);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-blink {
            animation: blink 2s infinite ease-in-out;
        }

        /* VS Neon Text */
        .vs-neon {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }

        /* Dual Range Slider Thumbs */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: auto;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #00D564;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            position: relative;
            z-index: 50;
            margin-top: -8px;
        }

        /* Firefox */
        input[type=range]::-moz-range-thumb {
            pointer-events: auto;
            height: 20px;
            width: 20px;
            border: none;
            border-radius: 50%;
            background: #00D564;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            position: relative;
            z-index: 50;
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        /* Reset for Firefox line height */
        input[type=range]::-moz-range-track {
            background: transparent;
        }
    </style>
    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="root"></div>

    <!-- React/Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="data.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Supabase Config ---
        const SUPABASE_URL = 'https://vxzdgyentxxipjervdzq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4emRneWVudHh4aXBqZXJ2ZHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjQ0ODEsImV4cCI6MjA4NDQwMDQ4MX0.HyZIWay1RI7JHVdVYpkWBTtjg9goQH4muUEaqqG6fPU';
        const supabaseInstance = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const supabaseClient = supabaseInstance;

        // --- Kakao Key Management ---
        const KAKAO_JS_KEY = '7716eb056c6c408381180fb2987a0279';

        const initKakao = () => {
            if (window.Kakao && !Kakao.isInitialized()) {
                try { Kakao.init(KAKAO_JS_KEY); } catch (e) { console.error("Kakao Init Failed:", e); }
            }
        };

        const TRANSLATIONS = {
            ko: {
                subtitle: "나의 취향에 맞는 네이버웹툰 찾기(With AI)",
                process: "분석 프로세스",
                step: "단계",
                of: "/",
                share: "공유하기",
                step1_title: "선호취향을 골라주세요.",
                step1_desc: "1개 이상 선택 필수!",
                cat_status: "연재 상태",
                cat_genre: "메인 장르",
                cat_topic: "인기 소재",
                cat_feature: "스토리 특징",
                next: "다음 단계",
                step2_title: "이런 웹툰 싫어~!",
                step2_desc: "선택한 취향이 포함된 웹툰은 추천에서 제외됩니다.",
                back: "이전",
                continue: "계속하기",
                step3_title: "가장 재미있게 보신\n웹툰은 무엇인가요?",
                step3_placeholder: "웹툰 제목을 입력해 주세요",
                start_analysis: "분석 시작",
                computing: "결과 계산 중...",
                result_title: "AI 추천 결과",
                result_desc: "사용자의 고유 취향을 분석한 결과입니다.",
                exclude: "추천제외",
                view_now: "보러가기",
                new_analysis: "새로운 분석",
                exclude_msg: "앞으로 이 웹툰은 추천되지 않습니다.",
                like: "좋아요",
                dislike: "싫어요",
                share_copy: "분석 결과가 복사되었습니다!",
                share_fail: "복사 실패",
                share_tpl_title: "[AIR.NW] AI 추천 결과",
                share_tpl_link: "나도 해보기",
                share_modal_title: "공유하기",
                share_to_kakao: "카카오톡",
                share_to_line: "라인",
                share_to_tiktok: "틱톡",
                share_to_text: "결과 복사",
                share_to_system: "기타 공유",
                conflict_msg: "단계 1에서 선택한 선호 태그입니다.\n비선호로 바꾸시겠습니까?",
                yes: "예",
                no: "아니오",
                main: "메인",
                ongoing: "연재중",
                finished: "완결",
                login: "로그인",
                logout: "로그아웃",
                email: "이메일",
                password: "비밀번호",
                login_btn: "로그인",
                signup_btn: "회원가입",
                social_login: "소셜 로그인",
                auth_title: "로그인 / 회원가입",
                like: "좋아요",
                my_info: "내 정보",
                liked_list: "선호 작품 (좋아요)",
                excluded_list: "비선호 작품 (싫어요)",
                delete_account: "회원 탈퇴",
                find_pw: "비밀번호 찾기",
                reset_pw_msg: "이메일로 비밀번호 재설정 링크가 발급됩니다.",
                delete_confirm: "정말로 탈퇴하시겠습니까?\n저장된 모든 데이터가 삭제됩니다.",
                no_data: "데이터가 없습니다.",
                password_confirm: "비밀번호 재확인",
                pw_mismatch: "비밀번호가 일치하지 않습니다.",
                pw_criteria: "비밀번호는 6자 이상이어야 합니다.",
                email_invalid: "유효한 이메일을 입력해주세요.",
                go_to_signup: "아직 계정이 없으신가요? 회원가입",
                go_to_login: "이미 계정이 있으신가요? 로그인",
                signup_confirm_msg: "가입 확인 메일이 발송되었습니다! 메일함을 확인해주세요.",
                login_error_msg: "로그인 정보가 올바르지 않습니다.",
                signup_success: "회원가입이 완료되었습니다!",
                worldcup: "웹툰 토너먼트",
                worldcup_title: "웹툰 토너먼트",
                worldcup_select_round: "라운드 선택",
                worldcup_start: "시작하기",
                worldcup_vs: "VS",
                worldcup_round: "강",
                worldcup_final: "결승",
                worldcup_winner: "우승",
                worldcup_result: "월드컵 결과",
                worldcup_history: "토너먼트 기록",
                worldcup_desc: "최고의 웹툰을 선정해보세요!",
                exclude_from_reco: "추천 제외",
                exclude_from_reco_desc: "선호도에는 영향을 주지만 추천 결과에서는 제외됩니다",
                today_visitors: "오늘 방문자",
                total_visitors: "총 방문자",
                random_mixing: "섞는 중...",
                help: "도움말",
                strict_exclude: "엄격 필터",
                random_min_score: "최소 점수",
                random_max_score: "최대 점수",
                random_genre_filter: "장르 필터 (선택 시 포함)",
                random_refresh: "랜덤추천 (결과보기)",
                random_no_results: "조건에 맞는 웹툰이 없습니다.",
                g_romance: "로맨스",
                g_fantasy: "판타지",
                g_action: "액션",
                g_martial: "무협/사극",
                g_drama: "드라마",
                g_daily: "일상",
                g_thriller: "스릴러",
                g_comedy: "개그",
                g_sports: "스포츠",
                t_ongoing: "연재중",
                t_dailyplus: "매일+",
                t_finished: "완결",
                t_regress: "회귀",
                t_op: "먼치킨",
                t_reborn: "환생",
                t_possess: "빙의",
                t_cidar: "사이다",
                random_title: "🎲 랜덤 웹툰 추천",
                random_subtitle: "조건에 맞는 웹툰을 20개씩 랜덤으로 추천해드립니다.",
                score_range: "별점 범위",
                help_title: "N웹툰 파인더 가이드 📘",
                help_disclaimer: "* 본 서비스는 네이버 웹툰 공식 서비스가 아니며, 사용자분들의 즐거운 웹툰 감상을 돕기 위해 제작된 비공식 팬 서비스입니다.",
                help_s1_title: "1. 🔍 똑똑한 검색",
                help_s1_desc: "제목이나 작가는 물론, '먼치킨', '회귀' 같은 키워드로도 검색할 수 있어요. 원하는 취향을 입력만 하세요!",
                help_s2_title: "2. ✨ 맞춤 AI추천",
                help_s2_desc: "'AI추천' 메뉴에서 간단한 질문에 답해보세요. AI가 수천 개의 웹툰 중 당신에게 딱 맞는 작품을 찾아드립니다.",
                help_s3_title: "3. 🏆 웹툰 토너먼트",
                help_s3_desc: "최대 2048강까지! 나만의 최애 웹툰을 뽑는 토너먼트를 즐겨보세요. 우승작은 당신의 취향 분석에도 반영됩니다.",
                help_s4_title: "4. 📚 나만의 컬렉션",
                help_s4_desc: "'❤️' 버튼을 눌러 컬렉션에 추가하고, '내 정보 > 나의 컬렉션'에서 친구들에게 리스트를 공유할 수 있습니다.",
                help_confirm: "확인했어요!"
            },
            en: {
                subtitle: "Find Naver Webtoons That Match Your Taste(With AI)",
                process: "Analysis Process",
                step: "Step",
                of: "of",
                share: "Share",
                step1_title: "Choose Preferred Tastes",
                step1_desc: "Please select at least one genre.",
                cat_status: "Status",
                cat_genre: "Main Genre",
                cat_topic: "Popular Topics",
                cat_feature: "Story Features",
                next: "Next Step",
                step2_title: "Choose Non-preferred Tastes (Optional)",
                step2_desc: "Webtoons with these tags will be strictly excluded.",
                back: "Back",
                continue: "Continue",
                step3_title: "What is your\nfavorite webtoon?",
                step3_placeholder: "Enter the webtoon title",
                start_analysis: "Start Analysis",
                computing: "Computing Result...",
                result_title: "AI Best Recommendations",
                result_desc: "Analyzed based on your unique preferences.",
                exclude: "Exclude",
                view_now: "View Now",
                new_analysis: "New Analysis",
                exclude_msg: "This webtoon will no longer be recommended.",
                like: "Like",
                dislike: "Dislike",
                share_copy: "Results copied to clipboard!",
                share_fail: "Copy failed.",
                share_tpl_title: "[AIR.NW] AI Recommended Results",
                share_tpl_link: "Try it yourself",
                share_modal_title: "Share Results",
                share_to_kakao: "KakaoTalk",
                share_to_line: "LINE",
                share_to_tiktok: "TikTok",
                share_to_text: "Copy Results",
                share_to_system: "Others",
                conflict_msg: "This is a preferred tag from Step 1.\nChange it to non-preferred?",
                yes: "Yes",
                no: "No",
                main: "Main",
                ongoing: "Ongoing",
                finished: "Finished",
                login: "Login",
                logout: "Logout",
                email: "Email",
                password: "Password",
                login_btn: "Login",
                signup_btn: "Sign Up",
                auth_title: "Login / Sign Up",
                like: "Like",
                my_info: "My Info",
                liked_list: "Preferred (Like)",
                excluded_list: "Disliked",
                delete_account: "Delete Account",
                find_pw: "Forgot Password?",
                reset_pw_msg: "A password reset link has been sent to your email.",
                delete_confirm: "Are you sure you want to delete your account?\nAll saved data will be permanently removed.",
                no_data: "No data found.",
                password_confirm: "Confirm Password",
                pw_mismatch: "Passwords do not match.",
                pw_criteria: "Password must be at least 6 characters.",
                email_invalid: "Please enter a valid email.",
                go_to_signup: "Don't have an account? Sign Up",
                go_to_login: "Already have an account? Login",
                signup_confirm_msg: "Confirmation email sent! Please check your inbox.",
                login_error_msg: "Invalid login credentials.",
                signup_success: "Sign-up completed successfully!",
                worldcup: "Webtoon Worldcup",
                worldcup_title: "Webtoon Ideal Type Worldcup",
                worldcup_select_round: "Select Round",
                worldcup_start: "Start",
                worldcup_vs: "VS",
                worldcup_round: "Round",
                worldcup_final: "Final",
                worldcup_winner: "Winner",
                worldcup_result: "Worldcup Result",
                worldcup_history: "Worldcup History",
                exclude_from_reco: "Exclude from Recommendations",
                exclude_from_reco_desc: "Affects preference but excluded from recommendation results",
                today_visitors: "Today",
                total_visitors: "Total",
                help: "Help",
                strict_exclude: "Strict Exclude",
                random_min_score: "Min Score",
                random_max_score: "Max Score",
                random_genre_filter: "Genre Filter (Select to include)",
                random_refresh: "Refresh (Random Results)",
                random_mixing: "Mixing...",
                random_no_results: "No webtoons match your criteria.",
                g_romance: "Romance",
                g_fantasy: "Fantasy",
                g_action: "Action",
                g_martial: "Martial Arts",
                g_drama: "Drama",
                g_daily: "Daily",
                g_thriller: "Thriller",
                g_comedy: "Comedy",
                g_sports: "Sports",
                t_ongoing: "Ongoing",
                t_dailyplus: "Daily+",
                t_finished: "Finished",
                t_regress: "Regression",
                t_op: "OP Main",
                t_reborn: "Reborn",
                t_possess: "Possession",
                t_cidar: "Justice",
                random_title: "🎲 Random Pick",
                random_subtitle: "We recommend 20 random webtoons that match your criteria.",
                score_range: "Score Range",
                help_title: "N-Webtoon Finder Guide 📘",
                help_disclaimer: "* This is an unofficial service and not an official Naver Webtoon service. Built with love for webtoon fans.",
                help_s1_title: "1. 🔍 Smart Search",
                help_s1_desc: "Search by title, author, or keywords like 'Munchkin'. Just enter what you're looking for!",
                help_s2_title: "2. ✨ AI Recommendation",
                help_s2_desc: "Answer a few questions in the AI Reco menu. Our AI will find the perfect webtoon for you.",
                help_s3_title: "3. 🏆 Webtoon Tournament",
                help_s3_desc: "Up to 2048 rounds! Pick your favorites in our tournament. Winners will affect your AI recommendations.",
                help_s4_title: "4. 📚 Personal Collection",
                help_s4_desc: "Tap '❤️' to save to your collection. Share your list with friends in 'My Info > My Collection'.",
                help_confirm: "Got it!"
            },
            zh: {
                subtitle: "我的 AI 网络漫画推荐 (With AI)",
                process: "分析流程",
                step: "阶段",
                of: "/",
                share: "分享",
                step1_title: "请选择您的偏好。",
                step1_desc: "至少选择1个！",
                cat_status: "连载状态",
                cat_genre: "主要类型",
                cat_topic: "热门素材",
                cat_feature: "故事特点",
                next: "下一步",
                step2_title: "这种漫画我不喜欢~！",
                step2_desc: "包含所选偏好的漫画将从推荐中排除。",
                back: "上一步",
                continue: "继续",
                step3_title: "您觉得最有趣的\n网络漫画是什么？",
                step3_placeholder: "请输入网络漫画标题",
                start_analysis: "开始分析",
                computing: "结果计算中...",
                result_title: "AI 推荐结果",
                result_desc: "这是基于用户独特偏好的分析结果。",
                exclude: "推荐排除",
                view_now: "立即阅读",
                new_analysis: "重新分析",
                exclude_msg: "今后将不再推荐此漫画。",
                like: "喜欢",
                dislike: "不喜欢",
                share_copy: "分析结果已复制！",
                share_fail: "复制失败",
                share_tpl_title: "[AIR.NW] AI 推荐结果",
                share_tpl_link: "我也要试试",
                share_modal_title: "分享",
                share_to_kakao: "KakaoTalk",
                share_to_line: "Line",
                share_to_tiktok: "TikTok",
                share_to_text: "复制结果",
                share_to_system: "其他分享",
                conflict_msg: "这是在阶段 1 中选择的偏好标签。\n要改为不喜欢吗？",
                yes: "是",
                no: "否",
                main: "主页",
                ongoing: "连载中",
                finished: "完结",
                login: "登录",
                logout: "登出",
                email: "电子邮箱",
                password: "密码",
                login_btn: "登录",
                signup_btn: "注册",
                social_login: "社交登录",
                auth_title: "登录 / 注册",
                like: "喜欢",
                my_info: "我的信息",
                liked_list: "喜欢作品 (Like)",
                excluded_list: "不喜欢作品 (Dislike)",
                delete_account: "注销账户",
                find_pw: "找回密码",
                reset_pw_msg: "重置密码链接将发送至您的邮箱。",
                delete_confirm: "确定要注销吗？\n所有保存的数据将被删除。",
                no_data: "暂无数据。",
                password_confirm: "密码确认",
                pw_mismatch: "密码不匹配。",
                pw_criteria: "密码至少 6 位。",
                email_invalid: "请输入有效的邮箱。",
                go_to_signup: "还没有账号？去注册",
                go_to_login: "已有账号？去登录",
                signup_confirm_msg: "验证邮件已发送！请检查您的邮箱。",
                login_error_msg: "登录信息不正确。",
                signup_success: "注册成功！",
                worldcup: "漫画世界杯",
                worldcup_title: "漫画理想型世界杯",
                worldcup_select_round: "选择轮数",
                worldcup_start: "开始",
                worldcup_vs: "VS",
                worldcup_round: "强",
                worldcup_final: "决赛",
                worldcup_winner: "冠军",
                worldcup_result: "世界杯结果",
                worldcup_history: "对决纪录",
                exclude_from_reco: "推荐排除",
                exclude_from_reco_desc: "影响偏好但在推荐结果中排除",
                today_visitors: "今日访问者",
                total_visitors: "总访问者",
                help: "帮助",
                strict_exclude: "严格排除",
                random_min_score: "最小评分",
                random_max_score: "最大评分",
                random_genre_filter: "类型筛选 (选择以包含)",
                random_refresh: "刷新 (查看随机结果)",
                random_mixing: "洗牌中...",
                random_no_results: "没有符合条件的漫画。",
                g_romance: "浪漫",
                g_fantasy: "幻想",
                g_action: "动作",
                g_martial: "武侠/史剧",
                g_drama: "剧情",
                g_daily: "日常",
                g_thriller: "惊悚",
                g_comedy: "搞笑",
                g_sports: "体育",
                t_ongoing: "连载中",
                t_dailyplus: "每日+",
                t_finished: "完结",
                t_regress: "回归",
                t_op: "无敌流",
                t_reborn: "重生",
                t_possess: "附身",
                t_cidar: "爽快",
                random_title: "🎲 随机漫画抽取",
                random_subtitle: "为您随机推荐20部符合条件的漫画。",
                score_range: "评分范围",
                help_title: "N网络漫画指南 📘",
                help_disclaimer: "* 本服务不是 NAVER WEBTOON 的官方服务，是为网络漫画迷制作的非官方粉丝服务。",
                help_s1_title: "1. 🔍 智能搜索",
                help_s1_desc: "不仅可以搜索标题或作者，还可以通过“无敌流”等关键词进行搜索。",
                help_s2_title: "2. ✨ AI 推荐",
                help_s2_desc: "在 AI 推荐菜单中回答简单问题。AI 将在数千部漫画中为您找到最合适的作品。",
                help_s3_title: "3. 🏆 漫画世界杯",
                help_s3_desc: "最多支持 2048 强！参加淘汰赛选出您最喜爱的漫画。冠军作品也将反映在您的偏好分析中。",
                help_s4_title: "4. 📚 我的收藏",
                help_s4_desc: "点击“❤️”按钮即可收藏。可以在“我的信息 > 我的收藏”中向朋友分享列表。",
                help_confirm: "我知道了！"
            },
            ja: {
                subtitle: "好みに合った Naver WebToon 探し (With AI)",
                process: "分析プロセス",
                step: "段階",
                of: "/",
                share: "共有",
                step1_title: "好みの設定",
                step1_desc: "1つ以上選択してください。",
                cat_status: "連載状況",
                cat_genre: "メインジャンル",
                cat_topic: "人気の素材",
                cat_feature: "ストーリーの特徴",
                next: "次へ",
                step2_title: "こんな漫画は苦手~！",
                step2_desc: "選択した好みが含まれる漫画は推奨から除外されます。",
                back: "戻る",
                continue: "続ける",
                step3_title: "一番面白かった\n漫画は何ですか？",
                step3_placeholder: "漫画のタイトルを入力してください",
                start_analysis: "分析開始",
                computing: "結果計算中...",
                result_title: "AI 推奨結果",
                result_desc: "ユーザーの独自の好みを分析した結果です。",
                exclude: "推奨除外",
                view_now: "見に行く",
                new_analysis: "新しい分析",
                exclude_msg: "今後この漫画は推奨されません。",
                like: "いいね",
                dislike: "嫌い",
                share_copy: "分析結果がコピーされました！",
                share_fail: "コピー失敗",
                share_tpl_title: "[AIR.NW] AI 推奨結果",
                share_tpl_link: "私もやってみる",
                share_modal_title: "共有",
                share_to_kakao: "KakaoTalk",
                share_to_line: "Line",
                share_to_tiktok: "TikTok",
                share_to_text: "結果をコピー",
                share_to_system: "その他",
                conflict_msg: "これはステップ 1 で選択した好みのタグです。\n嫌いに変更しますか？",
                yes: "はい",
                no: "いいえ",
                main: "メイン",
                ongoing: "連載中",
                finished: "完結",
                login: "ログイン",
                logout: "ログアウト",
                email: "メールアドレス",
                password: "パスワード",
                login_btn: "ログイン",
                signup_btn: "会員登録",
                social_login: "ソーシャルログイン",
                auth_title: "ログイン / 会員登録",
                like: "いいね",
                my_info: "マイ情報",
                liked_list: "好きな作品 (Like)",
                excluded_list: "嫌いな作品 (Dislike)",
                delete_account: "退会する",
                find_pw: "パスワードを忘れた場合",
                reset_pw_msg: "メールでパスワード再設定リンクが発行されます。",
                delete_confirm: "本当に退会しますか？\n保存されたすべてのデータが削除されます。",
                no_data: "データがありません。",
                password_confirm: "パスワードの再確認",
                pw_mismatch: "パスワードが一致しません。",
                pw_criteria: "パスワードは 6 文字以上である必要があります。",
                email_invalid: "有効なメールを入力してください。",
                go_to_signup: "アカウントをお持ちでないですか？ 会員登録",
                go_to_login: "既にアカウントをお持ちですか？ ログイン",
                signup_confirm_msg: "加入確認メールが送信されました！ メールを確認してください。",
                login_error_msg: "ログイン情報が正しくありません。",
                signup_success: "会員登録が完了しました！",
                worldcup: "ウェブトゥーンW杯",
                worldcup_title: "理想のウェブトゥーンW杯",
                worldcup_select_round: "ラウンド選択",
                worldcup_start: "開始",
                worldcup_vs: "VS",
                worldcup_round: "強",
                worldcup_final: "決勝",
                worldcup_winner: "優勝",
                worldcup_result: "W杯結果",
                worldcup_history: "対決履歴",
                exclude_from_reco: "推奨除外",
                today_visitors: "本日の訪問者",
                total_visitors: "総訪問者",
                help: "ヘルプ",
                strict_exclude: "厳密除外",
                random_min_score: "最小スコア",
                random_max_score: "最大スコア",
                random_genre_filter: "ジャンルフィルタ (選択時に含む)",
                random_refresh: "更新 (ランダム結果表示)",
                random_mixing: "シャッフル中...",
                random_no_results: "条件に合う漫画がありません。",
                g_romance: "ロマンス",
                g_fantasy: "ファンタジー",
                g_action: "アクション",
                g_martial: "武侠/史劇",
                g_drama: "ドラマ",
                g_daily: "日常",
                g_thriller: "スリラー",
                g_comedy: "ギャグ",
                g_sports: "スポーツ",
                t_ongoing: "連載中",
                t_dailyplus: "毎日+",
                t_finished: "完結",
                t_regress: "回帰",
                t_op: "最強主人公",
                t_reborn: "転生",
                t_possess: "憑依",
                t_cidar: "スカッと",
                random_title: "🎲 ランダム ウェブトゥーン 選び",
                random_subtitle: "条件に合うウェブトゥーンを20個ずつランダムでお勧めします。",
                score_range: "スコア範囲",
                help_title: "Nウェブトゥーン ファインダー ガイド 📘",
                help_disclaimer: "* 本サービスは Naver Webtoon の公式サービスではなく、ウェブトゥーンファンのために制作された非公式ファンサービスです。",
                help_s1_title: "1. 🔍 スマート検索",
                help_s1_desc: "タイトルや作者はもちろん、“最強”のようなキーワードでも検索できます。",
                help_s2_title: "2. ✨ パーソナライズ AI推奨",
                help_s2_desc: "AI推奨メニューで簡単な質問에 答えてみてください。AIがあなたにぴったりの作品を見つけ出します。",
                help_s3_title: "3. 🏆 ウェブトゥーンW杯",
                help_s3_desc: "最大 2048 強まで！お気に入りの作品を選ぶトーナメントを楽しんでください。結果は分析に反映されます。",
                help_s4_title: "4. 📚 マイコレクション",
                help_s4_desc: "「❤️」ボタンを押してコレクションに追加。「マイ情報 > マイコレクション」で共有も可能です。",
                help_confirm: "確認しました！"
            },
        };
        const getGenreCategories = (t) => [
            { name: t.cat_status, genres: ["연재중", "완결"], en: ["Ongoing", "Finished"], zh: ["连载中", "已完结"], ja: ["連載中", "完結"] },
            {
                name: t.cat_genre,
                genres: ["로맨스", "판타지", "액션", "드라마", "스릴러", "무협/사극", "개그", "일상", "감성", "스포츠"],
                en: ["Romance", "Fantasy", "Action", "Drama", "Thriller", "Martial Arts", "Comedy", "Life", "Sensibility", "Sports"],
                zh: ["浪漫", "奇幻", "动作", "剧情", "惊悚", "武侠/史剧", "搞笑", "日常", "感性", "体育"],
                ja: ["ロマンス", "ファンタジー", "アクション", "ドラマ", "スリラー", "武侠/時代劇", "ギャグ", "日常", "感성", "스포츠"]
            },
            {
                name: t.cat_topic,
                genres: ["회귀", "빙의", "먼치킨", "아이돌", "게임판타지", "복수", "학원물", "오피스", "로판", "이세계"],
                en: ["Regression", "Possession", "Munchkin", "Idol", "Game Fantasy", "Revenge", "School", "Office", "Rom-Fantasy", "Isekai"],
                zh: ["回归", "附身", "龙傲天", "偶像", "游戏奇幻", "复仇", "校园", "职场", "罗曼奇幻", "异世界"],
                ja: ["回帰", "憑依", "最強", "アイドル", "게임판타지", "復讐", "学園もの", "オフィス", "로판", "異世界"]
            },
            {
                name: t.cat_feature,
                genres: ["사이다", "힐링", "성장물", "두뇌싸움", "서스펜스"],
                en: ["Satisfying", "Healing", "Growth", "Brain Battle", "Suspense"],
                zh: ["爽文", "治愈", "成长", "脑力战", "悬疑"],
                ja: ["スカッと", "ヒーリング", "成長もの", "頭脳戦", "サスペンス"]
            }
        ];

        // 유사 장르 매핑 - 메인 장르 선택 시 관련 태그도 함께 반영
        const RELATED_GENRES = {
            // 메인 장르
            "로맨스": ["순정", "러브", "연애", "설렘", "달달", "소개팅", "짝사랑", "청춘로맨스", "학원로맨스", "리얼로맨스", "고자극로맨스", "혐관로맨스", "선결로맨스", "로코", "러블리", "직진남", "직진녀", "순애", "감성로맨스"],
            "판타지": ["마법", "던전", "이세계", "헌터물", "중세판타지", "동양풍판타지", "액션판타지", "다크판타지", "게임판타지", "판무", "용사", "마왕", "신화", "세계관", "이능력", "초능력", "마검"],
            "액션": ["배틀", "전투", "격투", "격투기", "이능력배틀물", "액션판타지", "액션아포칼립스", "싸움", "전쟁", "열혈", "소년왕도물"],
            "드라마": ["감성드라마", "성장드라마", "직업드라마", "고자극드라마", "감동", "하이퍼리얼리즘", "인간드라마", "사회고발", "사연"],
            "스릴러": ["공포", "호러", "미스터리", "서스펜스", "고자극스릴러", "범죄", "추리", "긴장감", "오컬트", "귀신", "살인", "잔혹"],
            "무협/사극": ["무협", "사극", "정통무협", "시대물", "동양", "동양풍판타지", "판무", "중국", "조선", "궁중"],
            "개그": ["코미디", "병맛", "일상개그", "판타지개그", "일상개그힐링", "개그물", "웃긴", "유머", "4차원", "공감성수치"],
            "일상": ["일상물", "슬라이스오브라이프", "힐링", "잔잔", "공감", "가벼운", "무해한", "소소한", "컷툰"],
            "감성": ["감성적인", "감동", "눈물", "힐링", "따뜻한", "잔잔", "심쿵", "설렘"],
            "스포츠": ["운동", "축구", "야구", "농구", "배구", "격투기", "복싱", "무술"],
            // 인기 소재
            "회귀": ["타임슬립", "시간이동", "과거회귀", "환생", "리셋", "다시시작", "두번째인생"],
            "빙의": ["빙의물", "영혼이동", "트랜스", "몸바꿈", "환생", "전생"],
            "먼치킨": ["사기캐", "최강", "무쌍", "고인물", "힘숨찐", "압도적", "성장물"],
            "아이돌": ["연예인", "아이돌물", "스타", "팬덤", "셀럽", "연예계"],
            "게임판타지": ["게임", "상태창", "레벨업", "시스템", "스탯", "헌터물", "던전물", "플레이어"],
            "복수": ["복수극", "복수물", "사이다", "피카레스크", "참교육"],
            "학원물": ["학교", "학생", "고등학교", "대학교", "청춘", "하이틴", "교복"],
            "오피스": ["회사", "직장", "사무실", "직장인", "비즈니스", "CEO", "재벌"],
            "로판": ["로맨스판타지", "성장로판", "여주", "공작", "황제", "황녀", "왕족/귀족", "빙의"],
            "이세계": ["이세계물", "차원이동", "소환", "다른세계", "평행세계", "이계"],
            // 스토리 특징
            "사이다": ["통쾌", "시원", "참교육", "복수", "피카레스크"],
            "힐링": ["힐링물", "따뜻한", "잔잔", "무해한", "휴식", "위로", "일상개그힐링"],
            "성장물": ["성장", "성장드라마", "성장로판", "소년왕도물", "주인공성장"],
            "두뇌싸움": ["심리전", "전략", "마인드게임", "지능전", "계략", "음모"],
            "서스펜스": ["긴장감", "미스터리", "스릴러", "추리", "반전"]
        };

        // 선택한 장르를 확장하여 관련 장르 키워드 배열 반환
        const expandGenres = (selectedGenres) => {
            const expanded = new Set();
            selectedGenres.forEach(genre => {
                // 원본 장르 추가
                if (genre.includes('/')) {
                    genre.split('/').forEach(g => expanded.add(g.trim()));
                } else {
                    expanded.add(genre);
                }
                // 관련 장르 추가
                const related = RELATED_GENRES[genre];
                if (related) {
                    related.forEach(r => expanded.add(r));
                }
            });
            return Array.from(expanded);
        };

        const MOCK_WEBTOONS = [
            { id: "641253", title: "외모지상주의", tags: ["에피소드", "액션", "박태준", "금요웹툰"], thumbnail: "https://image-comic.pstatic.net/webtoon/641253/thumbnail/thumbnail_IMAG21_d894f11f-668a-4046-8692-730a961f7743.jpg", match: 98, status: 'ONGOING' },
            { id: "183559", title: "신의 탑", tags: ["판타지", "먼치킨", "장대한서사"], thumbnail: "https://image-comic.pstatic.net/webtoon/183559/thumbnail/thumbnail_IMAG21_56133031-69f8-45a7-96a9-858348b4e720.jpg", match: 96, status: 'ONGOING' }
        ];

        const ProgressBar = ({ step, t }) => (
            <div className="mb-10 max-w-2xl mx-auto px-6">
                <div className="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div className="h-full bg-gradient-to-r from-primary to-primary-dark transition-all duration-700 ease-out" style={{ width: `${(step / 4) * 100}%` }}></div>
                </div>
                <div className="mt-4 flex justify-between text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                    <span>{t.process}</span>
                    <span className="text-primary">{t.step} {step} {t.of} 4</span>
                </div>
            </div>
        );

        const WebtoonCard = ({ item, rank, onDislike, onLike, onExcludeFromResult, isLiked, isDisliked, t, simpleMode = false, homeMode = false }) => {
            const isFinished = item.status === 'FINISHED';
            // 1~3등 트로피 이모지
            const getTrophyEmoji = (r) => {
                if (r === 1) return '🥇';
                if (r === 2) return '🥈';
                if (r === 3) return '🥉';
                return null;
            };
            const trophy = getTrophyEmoji(rank);

            return (
                <div className="flex flex-col gap-3 group relative card-hover p-3">
                    <div className="relative aspect-[3/4] rounded-xl overflow-hidden">
                        <img
                            src={item.thumbnail}
                            alt={item.title}
                            referrerPolicy="no-referrer"
                            className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                            loading="lazy"
                            onError={(e) => { e.target.src = "https://via.placeholder.com/300x400?text=No+Image"; }}
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent"></div>

                        {/* 등수 뱃지 - 좌측 상단, 작은 크기 */}
                        {rank > 0 && (
                            <div className="absolute top-2 left-2 z-10">
                                {trophy ? (
                                    <span className="text-lg drop-shadow-lg">{trophy}</span>
                                ) : (
                                    <span className="bg-gray-700/80 text-white text-[11px] font-bold px-2 py-0.5 rounded-md">{rank}</span>
                                )}
                            </div>
                        )}

                        <div className="absolute bottom-2 left-2 flex gap-1">
                            {isFinished && <span className="bg-gray-800/70 backdrop-blur-sm text-white text-[9px] font-bold px-2 py-0.5 rounded-md">{t.finished}</span>}
                            {!isFinished && <span className="bg-primary/90 text-white text-[9px] font-bold px-2 py-0.5 rounded-md">{t.ongoing}</span>}
                        </div>

                        {/* Top Right Heart Button */}
                        <button
                            onClick={(e) => { e.stopPropagation(); onLike(item.id); }}
                            className={`absolute top-2 right-2 p-2 rounded-full backdrop-blur-sm transition-all z-10 ${isLiked ? 'bg-red-500 text-white shadow-lg scale-110' : 'bg-white/80 text-gray-400 hover:bg-red-500 hover:text-white'}`}
                        >
                            <svg viewBox="0 0 24 24" className="w-4 h-4 fill-current"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                        </button>
                    </div>

                    <div className="flex flex-col gap-1">
                        <div className="flex justify-between items-start">
                            <h3 className="font-bold text-white text-[13px] truncate group-hover:text-primary transition-colors leading-tight">{item.title}</h3>
                            <div className="flex items-center gap-0.5 text-yellow-500 flex-shrink-0 bg-yellow-50 px-1.5 py-0.5 rounded">
                                <svg viewBox="0 0 24 24" className="w-3 h-3 fill-current"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>
                                <span className="text-[10px] font-bold text-gray-700">{item.starScore ? item.starScore.toFixed(2) : "0.0"}</span>
                            </div>
                        </div>
                        <p className="text-[11px] text-gray-400 font-medium truncate">{item.author}</p>
                    </div>

                    <div className="flex flex-col gap-2 mt-1">
                        <a
                            href={`https://comic.naver.com/webtoon/list?titleId=${item.id}`}
                            target="_blank"
                            className="w-full py-2 btn-gradient text-[#334155] font-bold text-[12px] rounded-lg text-center flex items-center justify-center gap-1"
                        >
                            <span>{t.view_now}</span>
                            <svg viewBox="0 0 24 24" className="w-3.5 h-3.5 fill-current"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                        </a>

                        <div className={`flex gap-1 ${homeMode ? 'hidden md:flex' : ''}`}>
                            <button
                                onClick={(e) => { e.stopPropagation(); onLike(item.id); }}
                                className={`flex-1 py-1.5 rounded-lg font-bold text-[9px] transition-all border flex items-center justify-center gap-1 ${isLiked ? 'bg-blue-500 text-white border-blue-200' : 'bg-gray-50 text-gray-400 border-gray-100 hover:text-blue-500 hover:border-blue-200'}`}
                            >
                                <svg viewBox="0 0 24 24" className={`w-3 h-3 ${isLiked ? 'fill-current' : 'fill-none stroke-current stroke-2'}`}><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                                {t.like}
                            </button>
                            <button
                                onClick={(e) => { e.stopPropagation(); onDislike(item.id); }}
                                className={`flex-1 py-1.5 rounded-lg font-bold text-[9px] transition-all border flex items-center justify-center gap-1 ${isDisliked ? 'bg-red-500 text-white border-red-200' : 'bg-gray-50 text-gray-400 border-gray-100 hover:text-red-500 hover:border-red-200'}`}
                            >
                                <svg viewBox="0 0 24 24" className="w-3 h-3 fill-none stroke-current stroke-2"><path d="M10 14h4M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                {t.dislike}
                            </button>
                            {onExcludeFromResult && (
                                <button
                                    onClick={(e) => { e.stopPropagation(); onExcludeFromResult(item.id); }}
                                    className="flex-1 py-1.5 rounded-lg font-bold text-[9px] transition-all border bg-gray-50 text-gray-400 border-gray-100 hover:bg-black hover:text-white hover:border-black flex items-center justify-center gap-1 whitespace-nowrap"
                                >
                                    <svg viewBox="0 0 24 24" className="w-3 h-3 fill-current"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"></path></svg>
                                    {t.exclude}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ShareModal = ({ isOpen, onClose, t, results }) => {
            const supabase = supabaseInstance;
            useEffect(() => {
                if (isOpen) {
                    document.body.classList.add('modal-open');
                    initKakao();
                } else { document.body.classList.remove('modal-open'); }
                return () => document.body.classList.remove('modal-open');
            }, [isOpen]);

            if (!isOpen) return null;

            const shareUrl = window.location.href;
            const fullRankText = results.map((w, i) => `${i + 1}. ${w.title} (${w.status === 'FINISHED' ? t.finished : t.ongoing})`).join('\n');
            const shareText = `${t.share_tpl_title}\n\n${fullRankText}\n\n🔗 ${t.share_tpl_link}: ${shareUrl}`;

            const copyToClip = () => {
                const el = document.createElement('textarea');
                el.value = shareText;
                document.body.appendChild(el);
                el.select();
                try { document.execCommand('copy'); alert(t.share_copy); } catch (e) { alert(t.share_fail); }
                document.body.removeChild(el);
                onClose();
            };

            const shareToKakao = () => {
                if (window.Kakao && Kakao.isInitialized()) {
                    try {
                        Kakao.Share.sendDefault({
                            objectType: 'feed',
                            content: {
                                title: t.share_tpl_title,
                                description: results.slice(0, 3).map(w => w.title).join(', ') + ' 등 추천됨',
                                imageUrl: results[0]?.thumbnail || 'https://comic.naver.com/static/img/common/naver_shared.png',
                                link: { mobileWebUrl: shareUrl, webUrl: shareUrl },
                            },
                            buttons: [{ title: t.share_tpl_link, link: { mobileWebUrl: shareUrl, webUrl: shareUrl } }],
                        });
                        return;
                    } catch (e) { console.error(e); }
                }
                if (navigator.share) { navigator.share({ title: t.share_tpl_title, text: shareText, url: shareUrl }).catch(() => { }); }
                else copyToClip();
            };

            const shareToLine = () => { window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank'); };

            return (
                <div className="modal-container" onClick={onClose}>
                    <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#161B28] w-full max-w-sm rounded-[56px] shadow-2xl overflow-hidden animate-up border border-white/10">
                            <div className="pt-12 pb-10 px-8 text-white">
                                <h3 className="text-2xl font-black text-center mb-10 tracking-tight">{t.share_modal_title}</h3>
                                <div className="grid grid-cols-2 gap-4 mb-8">
                                    <button onClick={shareToKakao} className="premium-gray-btn flex flex-col items-center gap-4 p-8 rounded-[36px]">
                                        <div className="w-16 h-16 flex items-center justify-center bg-[#FEE500] rounded-[24px] shadow-sm overflow-hidden"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e3/KakaoTalk_logo.svg" className="w-10 h-10 object-contain" alt="Kakao" /></div>
                                        <span className="text-sm font-black text-gray-300">{t.share_to_kakao}</span>
                                    </button>
                                    <button onClick={shareToLine} className="premium-gray-btn flex flex-col items-center gap-4 p-8 rounded-[36px]">
                                        <div className="w-16 h-16 flex items-center justify-center bg-[#06C755] rounded-[22px] shadow-sm overflow-hidden"><img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" className="w-10 h-10 object-contain" alt="LINE" /></div>
                                        <span className="text-sm font-black text-gray-700">{t.share_to_line}</span>
                                    </button>
                                    <button onClick={copyToClip} className="premium-gray-btn flex flex-col items-center gap-4 p-8 rounded-[36px]">
                                        <div className="w-16 h-16 flex items-center justify-center bg-black rounded-[22px] shadow-sm overflow-hidden"><img src="https://www.logo.wine/a/logo/TikTok/TikTok-Icon-Logo.wine.svg" className="w-[85%] h-[85%] object-contain" alt="TikTok" style={{ filter: 'brightness(1.5)' }} /></div>
                                        <span className="text-sm font-black text-gray-700">{t.share_to_tiktok}</span>
                                    </button>
                                    <button onClick={copyToClip} className="premium-gray-btn flex flex-col items-center gap-4 p-8 rounded-[36px]">
                                        <div className="w-16 h-16 flex items-center justify-center bg-slate-200 rounded-[22px] shadow-sm overflow-hidden text-slate-600"><svg viewBox="0 0 24 24" className="w-8 h-8 fill-current"><path d="M7 6V3C7 2.44772 7.44772 2 8 2H20C20.5523 2 21 2.44772 21 3V17C21 17.5523 20.5523 18 20 18H17V21C17 21.5523 16.5523 22 16 22H4C3.44772 22 3 21.5523 3 21V7C3 6.44772 3.44772 6 4 6H7ZM9 6H16V16H17V4H9V6ZM5 8V20H15V8H5Z"></path></svg></div>
                                        <span className="text-sm font-black text-gray-700">{t.share_to_text}</span>
                                    </button>
                                </div>
                                <button onClick={onClose} className="w-full py-5 bg-white/5 rounded-2xl text-gray-500 font-black hover:text-gray-300 transition-colors">CLOSE</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const HelpModal = ({ isOpen, onClose, t }) => {
            const supabase = supabaseInstance;

            useEffect(() => {
                const handleEsc = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [onClose]);

            if (!isOpen) return null;
            return (
                <div className="modal-container" onClick={onClose}>
                    <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#161B28] w-[90%] max-w-[414px] rounded-[40px] shadow-2xl p-7 animate-up border border-white/10">
                            <h3 className="text-xl font-black mb-1 text-primary tracking-tight">{t.help_title}</h3>
                            <p className="text-[10px] text-gray-400 font-bold mb-5 leading-normal break-keep opacity-90 italic">
                                {t.help_disclaimer}
                            </p>

                            <div className="space-y-4">
                                <div className="p-4 bg-white/5 rounded-2xl">
                                    <h4 className="font-black text-base mb-1 text-white">{t.help_s1_title}</h4>
                                    <p className="text-gray-400 text-[13px] leading-relaxed break-keep">{t.help_s1_desc}</p>
                                </div>

                                <div className="p-4 bg-white/5 rounded-2xl">
                                    <h4 className="font-black text-base mb-1 text-white">{t.help_s2_title}</h4>
                                    <p className="text-gray-400 text-[13px] leading-relaxed break-keep">{t.help_s2_desc}</p>
                                </div>

                                <div className="p-4 bg-white/5 rounded-2xl">
                                    <h4 className="font-black text-base mb-1 text-white">{t.help_s3_title}</h4>
                                    <p className="text-gray-400 text-[13px] leading-relaxed break-keep">{t.help_s3_desc}</p>
                                </div>

                                <div className="p-4 bg-white/5 rounded-2xl">
                                    <h4 className="font-black text-base mb-1 text-white">{t.help_s4_title}</h4>
                                    <p className="text-gray-400 text-[13px] leading-relaxed break-keep">{t.help_s4_desc}</p>
                                </div>
                            </div>

                            <button onClick={onClose} className="w-full mt-6 py-4 bg-white/5 text-white font-black rounded-2xl text-base hover:bg-white/10 active:scale-95 transition-all">
                                {t.help_confirm}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const WorldcupModal = ({ isOpen, onClose, t, user, onSaveResult, isViewMode = false }) => {
            const supabase = supabaseInstance;
            const [stage, setStage] = useState('select'); // 'select', 'playing', 'result'
            const [selectedRound, setSelectedRound] = useState(16);
            const [matches, setMatches] = useState([]);
            const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
            const [winners, setWinners] = useState([]);
            const [finalWinner, setFinalWinner] = useState(null);

            useEffect(() => {
                if (isOpen && !isViewMode) {
                    document.body.classList.add('modal-open');
                } else {
                    document.body.classList.remove('modal-open');
                }
                return () => document.body.classList.remove('modal-open');
            }, [isOpen, isViewMode]);

            if (!isOpen) return null;

            const startWorldcup = () => {
                const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                if (rawData.length < selectedRound) {
                    alert(`웹툰 데이터가 부족합니다. 최소 ${selectedRound}개 필요합니다.`);
                    return;
                }

                // Shuffle and select webtoons
                const shuffled = [...rawData].sort(() => Math.random() - 0.5);
                const selected = shuffled.slice(0, selectedRound);

                // Create initial matches
                const initialMatches = [];
                for (let i = 0; i < selected.length; i += 2) {
                    initialMatches.push([selected[i], selected[i + 1]]);
                }

                setMatches(initialMatches);
                setCurrentMatchIndex(0);
                setWinners([]);
                setStage('playing');
            };

            const selectWinner = (webtoon) => {
                const newWinners = [...winners, webtoon];

                if (currentMatchIndex + 1 < matches.length) {
                    // Move to next match
                    setCurrentMatchIndex(currentMatchIndex + 1);
                    setWinners(newWinners);
                } else {
                    // Round complete
                    if (newWinners.length === 1) {
                        // Tournament complete!
                        setFinalWinner(newWinners[0]);
                        setStage('result');
                        saveWorldcupResult(newWinners[0], selectedRound);
                    } else {
                        // Start next round
                        const nextMatches = [];
                        for (let i = 0; i < newWinners.length; i += 2) {
                            nextMatches.push([newWinners[i], newWinners[i + 1]]);
                        }
                        setMatches(nextMatches);
                        setCurrentMatchIndex(0);
                        setWinners([]);
                    }
                }
            };

            const saveWorldcupResult = async (winner, round) => {
                if (!user) return;

                const result = {
                    user_id: user.id,
                    winner_id: winner.titleId || winner.id,
                    winner_title: winner.titleName || winner.title,
                    round: round,
                    created_at: new Date().toISOString()
                };

                await supabaseClient.from('worldcup_results').insert(result);
                if (onSaveResult) onSaveResult(result);
            };

            const getCurrentRound = () => {
                const remaining = matches.length * 2;
                if (remaining === 2) return t.worldcup_final;
                return `${remaining}${t.worldcup_round}`;
            };

            const rounds = [8, 16, 32, 64, 128, 256, 512, 1024, 2048];

            const content = (
                <div className={`${isViewMode ? 'bg-transparent' : 'bg-white w-full max-w-4xl rounded-[56px] shadow-2xl overflow-hidden'} animate-up`}>
                    <div className="p-1 md:p-10">
                        {stage === 'select' && (
                            <div className="text-center py-2 md:py-10">
                                <h3 className="text-2xl md:text-3xl font-black mb-6 md:mb-10 tracking-tight italic border-b-2 border-primary/10 inline-block">{t.worldcup_title}</h3>
                                <p className="text-gray-400 font-medium mb-10 italic">{t.worldcup_desc}</p>
                                <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 md:gap-3 max-w-2xl mx-auto mb-12">
                                    {rounds.map(r => (
                                        <button key={r} onClick={() => setSelectedRound(r)} className={`px-2 md:px-4 py-3 rounded-2xl font-black transition-all whitespace-nowrap text-sm md:text-base ${selectedRound === r ? 'bg-primary text-white shadow-xl scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{r}{t.worldcup_round}</button>
                                    ))}
                                </div>
                                <button onClick={startWorldcup} className="w-full max-w-sm py-6 bg-primary text-white font-black rounded-full shadow-2xl hover:scale-105 active:scale-95 transition-all text-xl uppercase tracking-widest">
                                    {t.start || "시작하기"}
                                </button>
                            </div>
                        )}

                        {stage === 'playing' && (
                            <div className="text-center py-1 md:py-2">
                                <div className="flex justify-between items-center mb-4 md:mb-6 px-4 max-w-2xl mx-auto">
                                    <button
                                        onClick={() => setStage('select')}
                                        className="text-[10px] md:text-sm font-bold text-gray-400 hover:text-primary transition-colors flex items-center gap-1"
                                    >
                                        <svg viewBox="0 0 24 24" className="w-3 h-3 md:w-4 md:h-4 fill-none stroke-current stroke-3"><path d="M15 18l-6-6 6-6"></path></svg>
                                        처음으로
                                    </button>
                                    <div className="flex-1 text-center">
                                        <span className="px-3 py-1 bg-primary text-white text-[9px] md:text-[11px] font-black rounded-full shadow-md uppercase tracking-widest whitespace-nowrap">{getCurrentRound()}</span>
                                    </div>
                                    <div className="w-[60px] md:w-[80px]"></div> {/* Spacer for symmetry */}
                                </div>
                                <div className="flex flex-row items-stretch justify-center gap-2 md:gap-4 relative max-w-2xl mx-auto px-4">
                                    {matches[currentMatchIndex].map((w, idx) => (
                                        <div key={idx} onClick={() => selectWinner(w)} className="group cursor-pointer flex flex-col gap-1.5 w-1/2 max-w-[220px]">
                                            <div className="relative aspect-[2/3.1] rounded-lg md:rounded-[16px] overflow-hidden shadow-lg border border-white/5 transition-all group-hover:border-primary/50">
                                                <img src={w.thumbnailUrl || w.thumbnail} referrerPolicy="no-referrer" className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />

                                                {/* 텍스트 오버레이 (크기 추가 축소) */}
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-black/10 to-transparent flex flex-col justify-end p-2 md:p-4">
                                                    <h4 className="text-white text-xs md:text-lg font-black tracking-tighter leading-tight break-keep word-break-keep-all drop-shadow-lg mb-0.5">{w.titleName || w.title}</h4>
                                                    <p className="text-white/60 text-[7px] md:text-[9px] font-bold uppercase tracking-widest">{w.author}</p>
                                                </div>

                                                {/* 호버 효과 */}
                                                <div className="absolute inset-0 border-2 border-primary opacity-0 group-hover:opacity-100 transition-opacity rounded-lg md:rounded-[16px] pointer-events-none"></div>
                                            </div>

                                            {/* 선택 버튼 (85% 수준으로 축소) */}
                                            <button className="w-full py-1.5 md:py-2 rounded-lg font-black text-[9px] md:text-xs transition-all bg-white/10 text-white/40 group-hover:bg-primary group-hover:text-white active:scale-95">
                                                선택하기
                                            </button>
                                        </div>
                                    ))}

                                    {/* 중앙 VS (크기 85% 축소) */}
                                    <div className="absolute top-1/2 left-1/2 -translate-x-[51%] -translate-y-1/2 -mt-4 md:-mt-6 z-20 pointer-events-none w-full flex justify-center overflow-visible">
                                        <div className="text-2xl md:text-5xl font-black italic tracking-tighter select-none flex items-center justify-center filter drop-shadow-[0_0_15px_rgba(0,213,100,0.5)]">
                                            <span className="bg-gradient-to-b from-white via-primary to-primary-dark bg-clip-text text-transparent transform -skew-x-12 px-2">
                                                VS
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {stage === 'result' && finalWinner && (
                            <div className="text-center py-10">
                                <div className="mb-6"><span className="px-6 py-2 bg-yellow-400 text-white text-sm font-black rounded-full shadow-md uppercase tracking-widest italic">{t.worldcup_winner}</span></div>
                                <div className="mb-10 transform scale-110">
                                    <div className="relative w-64 sm:w-80 aspect-[3/4] mx-auto rounded-[64px] overflow-hidden shadow-[0_40px_80px_-20px_rgba(0,0,0,0.4)] border-[12px] border-yellow-400/20 bg-gray-100">
                                        <img src={finalWinner.thumbnailUrl || finalWinner.thumbnail} referrerPolicy="no-referrer" className="w-full h-full object-cover" />
                                        <div className="absolute top-6 right-6 w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center shadow-xl animate-bounce"><span className="text-3xl">🏆</span></div>
                                    </div>
                                    <h4 className="mt-12 text-3xl font-black text-gray-900 tracking-tighter italic leading-tight">{finalWinner.titleName || finalWinner.title}</h4>
                                    <p className="mt-3 text-gray-400 font-bold uppercase tracking-widest">{finalWinner.author}</p>
                                </div>
                                <div className="flex gap-4 justify-center">
                                    <button onClick={() => setStage('select')} className="px-10 py-5 bg-gray-50 text-gray-500 font-black rounded-full hover:bg-gray-100 transition-all uppercase tracking-widest text-sm">{t.retry}</button>
                                    <a href={`https://comic.naver.com/webtoon/list?titleId=${finalWinner.titleId || finalWinner.id}`} target="_blank" className="px-12 py-5 bg-primary text-white font-black rounded-full shadow-xl hover:scale-105 active:scale-95 transition-all uppercase tracking-widest text-sm italic">{t.view_now}</a>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            if (isViewMode) return content;

            return (
                <div className="modal-container" onClick={onClose}>
                    <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                        {content}
                    </div>
                </div>
            );
        };

        const App = () => {
            const supabase = supabaseInstance;
            const [lang, setLang] = useState('ko');
            const [view, setView] = useState('home'); // 'home', 'recommend', 'worldcup', 'search'
            const [step, setStep] = useState(1);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searchLimit, setSearchLimit] = useState(10);
            const [selectedG, setSelectedG] = useState([]);
            const [excludedG, setExcludedG] = useState([]); // Non-preferred tastes
            const [favTitle, setFavTitle] = useState("");
            const [manualExcludes, setManualExcludes] = useState(""); // Manual tags input
            const [loading, setLoading] = useState(false);
            const [results, setResults] = useState([]);
            const [scoredPool, setScoredPool] = useState([]);
            const [dislikedIds, setDislikedIds] = useState(() => {
                try { return JSON.parse(localStorage.getItem('excludedWebtoons')) || []; } catch (e) { return []; }
            });
            const [likedIds, setLikedIds] = useState([]);
            const [excludedFromRecoIds, setExcludedFromRecoIds] = useState([]);
            const [user, setUser] = useState(null);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [profileTab, setProfileTab] = useState('liked');
            const [worldcupHistory, setWorldcupHistory] = useState([]);
            const [showWorldcupModal, setShowWorldcupModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);
            const [conflictTag, setConflictTag] = useState(null);
            const [showExcludePopup, setShowExcludePopup] = useState(false);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [todayVisitors, setTodayVisitors] = useState(0);
            const [totalVisitors, setTotalVisitors] = useState(0);

            // --- Random Pick State ---
            const [randomMinScore, setRandomMinScore] = useState(9.0);
            const [randomMaxScore, setRandomMaxScore] = useState(10.0);
            const [randomGenres, setRandomGenres] = useState([]);
            const [randomResults, setRandomResults] = useState([]);
            const [hasRandomPicked, setHasRandomPicked] = useState(false);
            const [heroItems, setHeroItems] = useState([]);
            const [hiddenGemsRandom, setHiddenGemsRandom] = useState([]);

            const [isRandomLoading, setIsRandomLoading] = useState(false);

            const handleRandomPick = async (minScore, maxScore, genres) => {
                setIsRandomLoading(true);
                await new Promise(r => setTimeout(r, 800));
                const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                let filtered = rawData.filter(w => (w.starScore || 0) >= minScore && (w.starScore || 0) <= maxScore);

                if (genres.length > 0) {
                    filtered = filtered.filter(w => {
                        return (w.tags || []).some(t => genres.some(g => t.includes(g)));
                    });
                }

                // Fisher-Yates Shuffle
                const shuffled = [...filtered];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                // WebtoonCard 규격에 맞게 데이터 매핑 (titleName -> title, thumbnailUrl -> thumbnail 등)
                const normalized = shuffled.slice(0, 20).map(item => ({
                    ...item,
                    id: item.titleId || item.id,
                    title: item.titleName || item.title,
                    thumbnail: item.thumbnailUrl || item.thumbnail,
                    tags: item.tags || [],
                    author: item.author || "Unknown",
                    starScore: item.starScore || 0,
                    status: item.status || "ONGOING"
                }));

                setRandomResults(normalized);
                setRandomResults(normalized);
                setHasRandomPicked(true);
                setIsRandomLoading(false);
            };

            useEffect(() => {
                if (view === 'random') {
                    setHasRandomPicked(false);
                    setRandomResults([]);
                }
                if (view === 'home') {
                    const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                    const cleanHighRated = rawData
                        .filter(item => {
                            const combined = ((item.tags || []).join(' ') + (item.description || '') + (item.titleName || item.title)).toLowerCase();
                            const isClean = !combined.includes('성인웹툰') && !combined.includes('19금') && !combined.includes('성인') && !combined.includes('고자극');
                            const isHighRated = (item.starScore || 0) >= 9.80;
                            return isClean && isHighRated;
                        })
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 5)
                        .map(item => ({
                            id: item.titleId || item.id,
                            thumbnail: item.thumbnailUrl || item.thumbnail
                        }));
                    setHeroItems(cleanHighRated);

                    // 숨겨진 명작 발굴: 평점 9.97 이상 랜덤 20개
                    const hiddenGemsData = rawData
                        .filter(item => (item.starScore || 0) >= 9.97)
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 20)
                        .map(item => ({
                            id: item.titleId || item.id,
                            title: item.titleName || item.title,
                            thumbnail: item.thumbnailUrl || item.thumbnail,
                            tags: item.tags || [item.author],
                            status: item.status,
                            author: item.author,
                            starScore: item.starScore
                        }));
                    setHiddenGemsRandom(hiddenGemsData);
                }
            }, [view]);

            // Compute Top 5 Lists for Genres

            // Compute Top 5 Lists for Genres
            const { topWebtoons, hiddenGems, fantasyTop, romanceTop, martialTop, sliceTop } = useMemo(() => {
                const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                const sorted = [...rawData].sort((a, b) => (b.starScore || 0) - (a.starScore || 0));

                const getTopByGenre = (genreKeyword) => {
                    return sorted
                        .filter(w => (w.tags || []).some(t => t.includes(genreKeyword)))
                        .slice(0, 20)
                        .map(item => ({
                            id: item.titleId || item.id,
                            title: item.titleName || item.title,
                            thumbnail: item.thumbnailUrl || item.thumbnail,
                            tags: item.tags || [item.author],
                            status: item.status,
                            author: item.author,
                            starScore: item.starScore
                        }));
                };

                return {
                    topWebtoons: sorted.slice(0, 20).map(item => ({
                        id: item.titleId || item.id,
                        title: item.titleName || item.title,
                        thumbnail: item.thumbnailUrl || item.thumbnail,
                        tags: item.tags || [item.author],
                        status: item.status,
                        author: item.author,
                        starScore: item.starScore
                    })),
                    fantasyTop: getTopByGenre('판타지'),
                    romanceTop: getTopByGenre('로맨스'),
                    martialTop: getTopByGenre('무협'), // '무협/사극' usually
                    sliceTop: getTopByGenre('일상'),
                };
            }, []);

            const handleSearch = (q) => {
                setSearchQuery(q);
                if (!q.trim()) {
                    setSearchResults([]);
                    if (view === 'search') setView('home');
                    return;
                }
                const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                const filtered = rawData.filter(w =>
                    (w.titleName || w.title).toLowerCase().includes(q.toLowerCase()) ||
                    (w.author || '').toLowerCase().includes(q.toLowerCase()) ||
                    (w.tags || []).some(t => t.toLowerCase().includes(q.toLowerCase())) ||
                    (w.description || '').toLowerCase().includes(q.toLowerCase())
                ).map(item => ({
                    id: item.titleId || item.id,
                    title: item.titleName || item.title,
                    thumbnail: item.thumbnailUrl || item.thumbnail,
                    tags: (item.tags && item.tags.length > 0) ? item.tags : [item.author],
                    status: item.status,
                    author: item.author,
                    starScore: item.starScore
                }));
                setSearchResults(filtered);
                setSearchLimit(10);
                setView('search');
            };

            const t = TRANSLATIONS[lang] || TRANSLATIONS.ko;

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) { setUser(session.user); loadUserData(session.user.id); }
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    if (session) { setUser(session.user); loadUserData(session.user.id); }
                    else { setUser(null); setLikedIds([]); setDislikedIds([]); }
                });

                // Handle Signup Success Redirect
                if (window.location.hash.includes('type=signup')) {
                    alert(t.signup_success);
                    // Clear hash to avoid repeated alerts
                    window.history.replaceState(null, null, window.location.pathname);
                }

                return () => subscription.unsubscribe();
            }, [t]);

            // Visitor Counter Effect
            useEffect(() => {
                const trackVisitor = async () => {
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    const visitorKey = `visited_${today}`;

                    // Check if already visited today
                    if (!localStorage.getItem(visitorKey)) {
                        localStorage.setItem(visitorKey, 'true');

                        // Increment visitor count in Supabase
                        await supabaseClient.rpc('increment_visitor', { visit_date: today });
                    }

                    // Fetch visitor counts
                    const { data: todayData } = await supabase
                        .from('visitor_stats')
                        .select('count')
                        .eq('date', today)
                        .single();

                    const { data: totalData } = await supabase
                        .from('visitor_stats')
                        .select('count');

                    if (todayData) setTodayVisitors(todayData.count || 0);
                    if (totalData) setTotalVisitors(totalData.reduce((sum, row) => sum + (row.count || 0), 0));
                };

                trackVisitor();
            }, []);

            const loadUserData = async (userId) => {
                const { data: exData } = await supabaseClient.from('excluded_webtoons').select('webtoon_id').eq('user_id', userId);
                if (exData) setDislikedIds(exData.map(d => d.webtoon_id));
                const { data: favData } = await supabaseClient.from('favorite_webtoons').select('webtoon_id').eq('user_id', userId);
                if (favData) setLikedIds(favData.map(d => d.webtoon_id));

                // Load worldcup history
                const { data: wcData } = await supabaseClient.from('worldcup_results').select('*').eq('user_id', userId).order('created_at', { ascending: false });
                if (wcData) setWorldcupHistory(wcData);

                // Load excluded from recommendations
                const { data: exRecoData } = await supabaseClient.from('excluded_from_recommendations').select('webtoon_id').eq('user_id', userId);
                if (exRecoData) setExcludedFromRecoIds(exRecoData.map(d => d.webtoon_id));
            };

            const toggleLike = async (id) => {
                if (!user) { setShowAuthModal(true); return; }
                const isLiked = likedIds.includes(id);
                if (isLiked) {
                    await supabaseClient.from('favorite_webtoons').delete().eq('user_id', user.id).eq('webtoon_id', id);
                    setLikedIds(prev => prev.filter(it => it !== id));
                } else {
                    // Remove from dislikes if it was disliked
                    if (dislikedIds.includes(id)) toggleDislike(id);
                    await supabaseClient.from('favorite_webtoons').insert({ user_id: user.id, webtoon_id: id });
                    setLikedIds(prev => [...prev, id]);
                }
            };

            const categories = useMemo(() => getGenreCategories(t), [t]);

            const nextStep = () => { setStep(prev => prev + 1); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const prevStep = () => { setStep(prev => prev - 1); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const reset = () => { setStep(1); setSelectedG([]); setExcludedG([]); setFavTitle(""); setScoredPool([]); window.scrollTo({ top: 0, behavior: 'smooth' }); };

            const handleAnalyze = async () => {
                setLoading(true); setStep(4);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                await new Promise(r => setTimeout(r, 1500));
                const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                const genrePreferences = selectedG; // Step 1 now only contains genres
                const manualExcludeTags = manualExcludes.split(',').map(s => s.trim()).filter(Boolean);
                const allExcludes = [...excludedG, ...manualExcludeTags];

                const excludedStatus = allExcludes.filter(s => ["연재중", "매일+", "완결"].includes(s));
                const excludedGenreTags = allExcludes.filter(s => !["연재중", "매일+", "완결"].includes(s));

                // Similarity scoring based on liked webtoons
                const likedWebtoons = rawData.filter(w => likedIds.includes(w.titleId || w.id));
                const preferredLegacyTags = likedWebtoons.reduce((acc, curr) => [...acc, ...(curr.tags || [])], []);

                // Get worldcup winners for bonus scoring
                const worldcupWinnerIds = worldcupHistory.map(h => h.winner_id);

                const scoredData = rawData.map(item => {
                    const webtoon = {
                        id: item.titleId || item.id,
                        title: item.titleName || item.title,
                        thumbnail: item.thumbnailUrl || item.thumbnail,
                        tags: (item.tags && item.tags.length > 0) ? item.tags : [item.day, item.status === 'FINISHED' ? t.finished : t.ongoing, item.author].filter(Boolean),
                        author: item.author,
                        status: item.status,
                        description: item.description || "",
                        starScore: item.starScore || 0,
                        viewCount: item.viewCount || 0
                    };

                    if (dislikedIds.includes(webtoon.id)) return { ...webtoon, match: 0 };

                    let score = 50;

                    // 연재여부 제외 필터 (Step 2)
                    if (excludedStatus.length > 0) {
                        const myStatus = webtoon.status === 'FINISHED' ? '완결' : '연재중';
                        const isDailyPlus = String(item.day || item.category || "").toLowerCase().includes('plus') ||
                            (item.tags || []).some(t => t.includes('매일') || t.includes('플러스'));
                        if (excludedStatus.includes(myStatus)) return { ...webtoon, match: 0 };
                        if (isDailyPlus && excludedStatus.includes('매일+')) return { ...webtoon, match: 0 };
                    }

                    // 확장된 장르 매칭 (유사 장르 포함)
                    const expandedPrefs = expandGenres(genrePreferences);
                    const expandedExcluded = expandGenres(excludedGenreTags);

                    // 비선호 장르 체크 (확장된 키워드 적용)
                    if (expandedExcluded.length > 0) {
                        const hasExcludedTag = expandedExcluded.some(ex =>
                            webtoon.tags.some(t => String(t).toLowerCase().includes(ex.toLowerCase())) ||
                            webtoon.title.toLowerCase().includes(ex.toLowerCase()) ||
                            webtoon.description.toLowerCase().includes(ex.toLowerCase())
                        );
                        if (hasExcludedTag) return { ...webtoon, match: 0 };
                    }

                    // 선호 장르 점수 계산 (확장된 키워드 적용)
                    expandedPrefs.forEach(pref => {
                        if (webtoon.tags.some(t => String(t).toLowerCase().includes(pref.toLowerCase())) ||
                            webtoon.title.toLowerCase().includes(pref.toLowerCase()) ||
                            webtoon.description.toLowerCase().includes(pref.toLowerCase())) {
                            score += 15; // 유사 장르는 약간 낮은 점수
                        }
                    });

                    // 원본 선호 장르는 추가 보너스
                    genrePreferences.forEach(pref => {
                        const keywords = pref.includes('/') ? pref.split('/') : [pref];
                        if (keywords.some(k =>
                            webtoon.tags.some(t => String(t).includes(k)) ||
                            webtoon.title.includes(k) ||
                            webtoon.description.includes(k)
                        )) {
                            score += 10; // 원본 매칭 보너스
                        }
                    });

                    // Bonus for similarity to liked webtoons
                    if (preferredLegacyTags.length > 0) {
                        const overlap = webtoon.tags.filter(tag => preferredLegacyTags.includes(tag)).length;
                        score += (overlap * 5);
                    }

                    // Bonus for worldcup winners
                    if (worldcupWinnerIds.includes(webtoon.id)) {
                        score += 15;
                    }

                    return { ...webtoon, match: Math.min(99, score + (Math.random() * 5)) };
                });

                const sorted = scoredData.filter(w => w.match > 0 && !excludedFromRecoIds.includes(w.id)).sort((a, b) => {
                    let scoreA = a.match;
                    let scoreB = b.match;
                    if (dislikedIds.includes(a.id)) scoreA -= 50;
                    if (dislikedIds.includes(b.id)) scoreB -= 50;
                    if (scoreB !== scoreA) return scoreB - scoreA;
                    if (b.starScore !== a.starScore) return b.starScore - a.starScore;
                    return b.viewCount - a.viewCount;
                });
                setScoredPool(sorted);
                setResults(sorted.slice(0, 10));
                setLoading(false);
            };

            const toggleDislike = async (id) => {
                if (!user) { setShowAuthModal(true); return; }
                const isDisliked = dislikedIds.includes(id);
                if (isDisliked) {
                    await supabaseClient.from('excluded_webtoons').delete().eq('user_id', user.id).eq('webtoon_id', id);
                    const newDislikedIds = dislikedIds.filter(it => it !== id);
                    setDislikedIds(newDislikedIds);
                    localStorage.setItem('excludedWebtoons', JSON.stringify(newDislikedIds));
                } else {
                    // Remove from likes if it was liked
                    if (likedIds.includes(id)) toggleLike(id);
                    await supabaseClient.from('excluded_webtoons').insert({ user_id: user.id, webtoon_id: id });
                    const newDislikedIds = [...dislikedIds, id];
                    setDislikedIds(newDislikedIds);
                    localStorage.setItem('excludedWebtoons', JSON.stringify(newDislikedIds));
                }
            };

            // 추천 결과에서만 제외 (선호에 영향 없음)
            const excludeFromResult = (id) => {
                // 현재 결과에서 제외하고, scoredPool에서 다음 웠툰 가져오기
                const currentResultIds = results.map(r => r.id);
                const remainingPool = scoredPool.filter(w => !currentResultIds.includes(w.id) || w.id === id);
                const newResults = results.filter(r => r.id !== id);

                // 다음 순위 웠툰 추가 (현재 10개 미만이면)
                if (newResults.length < 10 && remainingPool.length > 0) {
                    const nextInPool = scoredPool.find(w => !newResults.some(r => r.id === w.id) && w.id !== id);
                    if (nextInPool) {
                        newResults.push(nextInPool);
                    }
                }

                setResults(newResults);

                // 팝업 표시
                setShowExcludePopup(true);
                setTimeout(() => setShowExcludePopup(false), 2000);
            };

            const HorizontalSlider = ({ items, rankOffset = 0, t, toggleDislike, toggleLike, excludeFromResult, likedIds, dislikedIds }) => {
                const scrollRef = React.useRef(null);
                const [showLeft, setShowLeft] = React.useState(false);

                const scroll = (dir) => {
                    if (scrollRef.current) {
                        const containerWidth = scrollRef.current.offsetWidth;
                        const amount = dir === 'left' ? -containerWidth : containerWidth;
                        scrollRef.current.scrollBy({ left: amount, behavior: 'smooth' });
                    }
                };

                const handleScroll = () => {
                    if (scrollRef.current) {
                        setShowLeft(scrollRef.current.scrollLeft > 10);
                    }
                };

                return (
                    <div className="relative group/slider">
                        {showLeft && (
                            <button
                                onClick={() => scroll('left')}
                                className="absolute left-1 md:left-[-20px] top-1/2 -translate-y-1/2 z-20 w-10 h-10 md:w-11 md:h-11 bg-black/60 md:bg-black/90 text-white rounded-full flex items-center justify-center border border-white/10 hover:bg-primary transition-all shadow-2xl opacity-100 md:opacity-0 md:group-hover/slider:opacity-100"
                            >
                                <svg viewBox="0 0 24 24" className="w-5 h-5 md:w-6 md:h-6 fill-current rotate-180"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                            </button>
                        )}
                        <button
                            onClick={() => scroll('right')}
                            className="absolute right-1 md:right-[-20px] top-1/2 -translate-y-1/2 z-20 w-10 h-10 md:w-11 md:h-11 bg-black/60 md:bg-black/90 text-white rounded-full flex items-center justify-center border border-white/10 hover:bg-primary transition-all shadow-2xl opacity-100 md:opacity-0 md:group-hover/slider:opacity-100"
                        >
                            <svg viewBox="0 0 24 24" className="w-5 h-5 md:w-6 md:h-6 fill-current"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                        </button>

                        <div
                            ref={scrollRef}
                            onScroll={handleScroll}
                            className="flex overflow-x-hidden gap-5 pb-6 scroll-smooth snap-x snap-mandatory"
                        >
                            {items.map((w, idx) => (
                                <div key={w.id} className="flex-shrink-0 w-[calc((100%-20px)/2)] md:w-[calc((100%-80px)/5)] snap-start">
                                    <WebtoonCard
                                        item={w}
                                        rank={rankOffset + idx + 1}
                                        onDislike={toggleDislike}
                                        onLike={toggleLike}
                                        onExcludeFromResult={excludeFromResult}
                                        isDisliked={dislikedIds.includes(w.id)}
                                        t={t}
                                        homeMode={true}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    <header>
                        <div className="max-w-[1500px] mx-auto px-6 h-16 flex items-center justify-between gap-8">
                            {/* Left: Brand & Nav */}
                            <div className="flex items-center gap-8 flex-shrink-0">
                                <button onClick={() => setView('home')} className="flex items-center gap-1 group">
                                    <span className="text-xl font-black tracking-tight">
                                        <span className="text-primary">N웹툰</span>
                                        <span className="text-white ml-1">FINDER</span>
                                    </span>
                                </button>
                                <nav className="hidden md:flex items-center gap-6">
                                    <button onClick={() => setView('home')} className={`text-sm font-semibold transition-colors ${view === 'home' ? 'text-primary' : 'text-gray-400 hover:text-white'}`}>{lang === 'ko' ? '홈' : 'Home'}</button>
                                    <button onClick={() => { setView('recommend'); setStep(1); }} className={`text-sm font-semibold transition-colors ${view === 'recommend' ? 'text-primary' : 'text-gray-400 hover:text-white'}`}>{lang === 'ko' ? 'AI추천' : 'AI Reco'}</button>
                                    <button onClick={() => { setView('random'); }} className={`text-sm font-semibold transition-colors ${view === 'random' ? 'text-primary' : 'text-gray-400 hover:text-white'}`}>{lang === 'ko' ? '랜덤추천' : 'Random Pick'}</button>
                                    <button onClick={() => {
                                        setView('worldcup');
                                        if (!user) alert(lang === 'ko' ? "로그인 시 내 취향에 반영됩니다!" : "Login to reflect in your preferences!");
                                    }} className={`text-sm font-semibold transition-colors ${view === 'worldcup' ? 'text-primary' : 'text-gray-400 hover:text-white'}`}>{t.worldcup}</button>
                                    <button onClick={() => setShowHelpModal(true)} className={`text-sm font-semibold transition-colors ${showHelpModal ? 'text-primary' : 'text-gray-400 hover:text-white'}`}>{t.help}</button>
                                </nav>
                            </div>

                            {/* Center: Search (Desktop) */}
                            <div className="hidden md:block flex-grow max-w-xl relative">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                    <svg viewBox="0 0 24 24" className="w-4 h-4 fill-current"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                                </div>
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => handleSearch(e.target.value)}
                                    placeholder={lang === 'ko' ? '작가, 장르, 키워드 등을 입력해보세요' : 'Search titles, authors, keywords'}
                                    className="w-full bg-white/5 border border-white/10 rounded-xl py-2.5 pl-12 pr-4 text-sm font-medium outline-none text-white placeholder:text-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/20 transition-all"
                                />
                            </div>

                            {/* Mobile Help Icon */}
                            <div className="md:hidden flex-grow flex justify-end">
                                <button onClick={() => setShowHelpModal(true)} className="p-2 text-white opacity-80 hover:opacity-100 transition-all">
                                    <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current"><path d="M11.07,12.85c0.77-1.39,2.25-2.21,3.11-3.44c0.91-1.29,0.4-3.7-1.75-3.9c-1.27-0.12-2.23,0.33-2.8,1.34L8,5.74c1.21-1.94,3.19-2.55,5.74-2.2c3.15,0.43,4.02,3.07,3.01,5.56c-0.65,1.6-2.34,2.51-3.03,3.61c-0.31,0.51-0.29,1.51-0.29,2.1h-3C10.44,14.08,10.6,13.7,11.07,12.85z M14,19c0,1.1-0.9,2-2,2s-2-0.9-2-2c0-1.1,0.9-2,2-2S14,17.9,14,19z" /></svg>
                                </button>
                            </div>

                            {/* Right: Actions */}
                            <div className="flex items-center gap-4 flex-shrink-0">
                                <div className="hidden md:flex items-center gap-1 scale-90 border-r border-gray-200 pr-4 mr-2">
                                    {[{ code: 'ko', label: 'KO' }, { code: 'en', label: 'EN' }, { code: 'zh', label: 'ZH' }, { code: 'ja', label: 'JA' }].map(l => (
                                        <button key={l.code} onClick={() => setLang(l.code)}
                                            className={`px-2 py-1 rounded-md border text-[9px] font-bold transition-all ${lang === l.code ? 'bg-primary border-primary text-white' : 'bg-white text-gray-400 border-gray-200 hover:border-gray-400'}`}>
                                            {l.label}
                                        </button>
                                    ))}
                                </div>
                                {user ? (
                                    <div className="hidden md:flex items-center gap-4">
                                        <button onClick={() => setShowProfileModal(true)} className="text-sm font-semibold text-gray-500 hover:text-gray-800">{lang === 'ko' ? '내 정보' : 'Profile'}</button>
                                        <button onClick={() => supabase.auth.signOut()} className="text-sm font-semibold text-gray-400 hover:text-red-500">{lang === 'ko' ? '로그아웃' : 'Logout'}</button>
                                    </div>
                                ) : (
                                    <div className="hidden md:flex items-center gap-2">
                                        <button onClick={() => { setShowAuthModal(true); setAuthMode('login'); }} className="text-xs font-bold bg-white/5 border border-white/10 text-white px-4 py-2 rounded-full hover:bg-white/10 transition-all">{lang === 'ko' ? '로그인' : 'Log In'}</button>
                                        <button onClick={() => { setShowAuthModal(true); setAuthMode('signup'); email && setAuthMode('signup'); }} className="text-xs font-bold btn-gradient text-[#334155] px-4 py-2 rounded-full">{lang === 'ko' ? '회원가입' : 'Sign Up'}</button>
                                    </div>
                                )}
                                {/* Mobile Menu -> Just Profile/Login Icon */}
                                <div className="md:hidden flex items-center">
                                    {user ? (
                                        <button onClick={() => setShowProfileModal(true)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs text-white">
                                            MY
                                        </button>
                                    ) : (
                                        <button onClick={() => { setShowAuthModal(true); setAuthMode('login'); }} className="text-xs font-bold text-gray-300">
                                            Login
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-[1500px] mx-auto px-4 md:px-10 py-6 md:py-10 mb-20 md:mb-0">
                        {view === 'home' && (
                            <div className="animate-up space-y-16">
                                {/* Hero Section */}
                                <div className="relative pt-4 pb-4 rounded-3xl overflow-hidden hero-gradient">
                                    <div className="flex flex-col lg:flex-row items-stretch gap-8 lg:gap-0 min-h-[320px]">
                                        <div className="flex-1 space-y-12 z-10 pl-8 lg:pl-16 self-center">
                                            <h1 className="text-3xl lg:text-5xl font-black leading-[1.8] text-white tracking-tight">
                                                지금, 당신의 심장을 뛰게 할<br />
                                                <span className="text-primary">웹툰</span>을 찾아보세요
                                            </h1>
                                            <p className="text-gray-500 text-base max-w-md">
                                                AI가 분석한 수천 개의 웹툰 중 당신의 취향저격 <br className="md:hidden" />작품을 추천해 드립니다.
                                            </p>
                                            <button
                                                onClick={() => { setView('recommend'); setStep(1); }}
                                                className="btn-gradient text-[#334155] font-bold text-base px-8 py-4 rounded-full animate-pulse-glow flex items-center gap-2"
                                            >
                                                지금 바로 추천받기 ✨
                                            </button>
                                        </div>
                                        {/* 우측 웹툰 커버 - 세련된 사선 슬라이스 배치 */}
                                        <div className="hidden lg:flex flex-1 relative items-stretch overflow-hidden gap-[3px] px-8">
                                            {heroItems.map((w, i) => (
                                                <a
                                                    href={`https://comic.naver.com/webtoon/list?titleId=${w.id}`}
                                                    target="_blank"
                                                    key={w.id}
                                                    className="relative flex-1 group transition-all duration-700 hover:flex-[3] overflow-hidden cursor-pointer"
                                                    style={{
                                                        clipPath: 'polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%)',
                                                    }}
                                                >
                                                    <div className="absolute inset-0 transition-all duration-500 scale-110 group-hover:scale-100">
                                                        <img
                                                            src={w.thumbnail}
                                                            alt={`hero-${i}`}
                                                            className="w-full h-full object-cover"
                                                            referrerPolicy="no-referrer"
                                                        />
                                                    </div>
                                                    {/* 상하 블러 마스크 - 얇게 모서리만 */}
                                                    <div className="absolute inset-x-0 top-0 h-4 bg-gradient-to-b from-black/60 to-transparent backdrop-blur-[1px]"></div>
                                                    <div className="absolute inset-x-0 bottom-0 h-4 bg-gradient-to-t from-black/60 to-transparent backdrop-blur-[1px]"></div>
                                                    {/* 내부 셰도우 */}
                                                    <div className="absolute inset-0 bg-gradient-to-r from-black/10 via-transparent to-black/10 group-hover:from-transparent"></div>
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Real-time Trends */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">🔥</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '평점 Top 20' : 'Star Rating Top 20'}</h2>
                                        <span className="text-[10px] font-bold bg-primary/10 text-primary px-3 py-1 rounded-full uppercase">{lang === 'ko' ? '#추천' : 'Recommended'}</span>
                                    </div>
                                    <HorizontalSlider items={topWebtoons} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>

                                {/* Hidden Gems */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">💎</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '숨겨진 명작 발굴' : 'Hidden Gems'}</h2>
                                    </div>
                                    <HorizontalSlider items={hiddenGemsRandom} rankOffset={-1} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>

                                {/* Fantasy Top 20 */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">🐲</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '판타지 Top 20' : 'Fantasy Top 20'}</h2>
                                    </div>
                                    <HorizontalSlider items={fantasyTop} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>

                                {/* Romance Top 20 */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">💖</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '로맨스 Top 20' : 'Romance Top 20'}</h2>
                                    </div>
                                    <HorizontalSlider items={romanceTop} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>

                                {/* Martial Arts Top 20 */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">⚔️</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '무협/사극 Top 20' : 'Martial Arts Top 20'}</h2>
                                    </div>
                                    <HorizontalSlider items={martialTop} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>

                                {/* Slice of Life Top 20 */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <span className="text-xl">🌱</span>
                                        <h2 className="text-xl font-bold text-white">{lang === 'ko' ? '일상 Top 20' : 'Slice of Life Top 20'}</h2>
                                    </div>
                                    <HorizontalSlider items={sliceTop} t={t} toggleDislike={toggleDislike} toggleLike={toggleLike} excludeFromResult={excludeFromResult} likedIds={likedIds} dislikedIds={dislikedIds} />
                                </div>
                            </div>
                        )}

                        {view === 'random' && (
                            <div className="animate-up">
                                <div className="mb-10 text-center">
                                    <h2 className="text-3xl font-black text-white mb-2">{t.random_title}</h2>
                                    <p className="text-gray-500 text-sm">{t.random_subtitle}</p>
                                </div>

                                <div className="bg-[#161B28] rounded-3xl p-8 mb-12 border border-white/5 shadow-2xl">
                                    <div className="flex flex-col gap-8">
                                        {/* Filters */}
                                        <div className="flex flex-col md:flex-row gap-8 items-start">
                                            <div className="flex-1 w-full">
                                                <div className="flex justify-between mb-4">
                                                    <h3 className="text-white font-bold text-sm uppercase tracking-widest">{t.score_range} ({randomMinScore} ~ {randomMaxScore})</h3>
                                                </div>
                                                <div className="relative w-full h-12 flex items-center select-none touch-none">
                                                    {/* Track Background */}
                                                    <div className="absolute w-full h-2 bg-gray-700 rounded-full z-0"></div>
                                                    {/* Active Track */}
                                                    <div
                                                        className="absolute h-2 bg-primary rounded-full z-10"
                                                        style={{ left: `${randomMinScore * 10}%`, width: `${(randomMaxScore - randomMinScore) * 10}%` }}
                                                    ></div>

                                                    {/* Min Input */}
                                                    <input
                                                        type="range"
                                                        min="0" max="10" step="0.1"
                                                        value={randomMinScore}
                                                        onChange={(e) => {
                                                            const val = Math.min(parseFloat(e.target.value), randomMaxScore - 0.5);
                                                            setRandomMinScore(val);
                                                        }}
                                                        className="absolute w-full h-full appearance-none pointer-events-none z-20"
                                                    />
                                                    {/* Max Input */}
                                                    <input
                                                        type="range"
                                                        min="0" max="10" step="0.1"
                                                        value={randomMaxScore}
                                                        onChange={(e) => {
                                                            const val = Math.max(parseFloat(e.target.value), randomMinScore + 0.5);
                                                            setRandomMaxScore(val);
                                                        }}
                                                        className="absolute w-full h-full appearance-none pointer-events-none z-20"
                                                    />
                                                </div>
                                            </div>
                                            <div className="flex-1 w-full">
                                                <h3 className="text-white font-bold text-sm uppercase tracking-widest mb-4">{t.random_genre_filter}</h3>
                                                <div className="flex flex-wrap gap-2">
                                                    {[
                                                        { k: '로맨스', t: t.g_romance },
                                                        { k: '판타지', t: t.g_fantasy },
                                                        { k: '액션', t: t.g_action },
                                                        { k: '무협/사극', t: t.g_martial },
                                                        { k: '드라마', t: t.g_drama },
                                                        { k: '일상', t: t.g_daily },
                                                        { k: '스릴러', t: t.g_thriller },
                                                        { k: '개그', t: t.g_comedy },
                                                        { k: '스포츠', t: t.g_sports }
                                                    ].map(g => (
                                                        <button
                                                            key={g.k}
                                                            onClick={() => setRandomGenres(prev => prev.includes(g.k) ? prev.filter(it => it !== g.k) : [...prev, g.k])}
                                                            className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${randomGenres.includes(g.k) ? 'bg-primary border-primary text-white' : 'bg-white/5 border-white/10 text-gray-400 hover:border-gray-500'}`}
                                                        >
                                                            {g.t}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        {/* Refresh Button */}
                                        <button
                                            onClick={() => handleRandomPick(randomMinScore, randomMaxScore, randomGenres)}
                                            disabled={isRandomLoading}
                                            className={`w-full py-4 bg-primary text-white font-black rounded-2xl shadow-lg transition-all text-lg flex items-center justify-center gap-2 ${isRandomLoading ? 'opacity-70 cursor-wait' : 'hover:scale-[1.01] active:scale-95'}`}
                                        >
                                            <span>{isRandomLoading ? '⏳' : '🔄'}</span> {isRandomLoading ? (t.random_mixing || 'Mixing...') : t.random_refresh}
                                        </button>
                                    </div>
                                </div>

                                {/* Grid Results */}
                                {(!hasRandomPicked && !isRandomLoading) ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">
                                        {[...Array(10)].map((_, i) => (
                                            <div key={i} className="aspect-[3/4] rounded-2xl bg-[#161B28] overflow-hidden border border-white/5 relative group">
                                                <div className="absolute inset-0 flex items-center justify-center">
                                                    <img src="question_mark.png" alt="?" className="w-1/2 h-1/2 object-contain opacity-50 group-hover:opacity-100 transition-opacity drop-shadow-[0_0_15px_rgba(0,213,100,0.5)]" />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <>
                                        {isRandomLoading ? (
                                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">
                                                {[...Array(10)].map((_, i) => (
                                                    <div key={i} className="aspect-[3/4] rounded-2xl bg-white/5 animate-pulse border border-white/5"></div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">
                                                {randomResults.map((w, idx) => (
                                                    <div key={w.id + idx} className="animate-in fade-in zoom-in duration-500" style={{ animationDelay: `${idx * 50}ms` }}>
                                                        <WebtoonCard item={w} rank={0} onDislike={toggleDislike} onLike={toggleLike} onExcludeFromResult={excludeFromResult} isLiked={likedIds.includes(w.id)} isDisliked={dislikedIds.includes(w.id)} t={t} />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                )}
                                {hasRandomPicked && !isRandomLoading && randomResults.length === 0 && (
                                    <div className="py-20 text-center text-gray-500 font-bold">{t.random_no_results}</div>
                                )}
                            </div>
                        )}

                        {
                            view === 'search' && (
                                <div className="animate-up">
                                    <div className="mb-10">
                                        {/* Mobile Search Input */}
                                        <div className="md:hidden mb-6">
                                            <input
                                                type="text"
                                                value={searchQuery}
                                                onChange={(e) => handleSearch(e.target.value)}
                                                placeholder={lang === 'ko' ? '작가, 장르, 키워드 검색' : 'Search...'}
                                                autoFocus
                                                className="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-6 text-base font-medium outline-none text-white placeholder:text-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/20 transition-all"
                                            />
                                        </div>

                                        <h2 className="text-xl font-bold mb-6 text-white">{lang === 'ko' ? `'${searchQuery}' 검색 결과` : `Search results for '${searchQuery}'`}</h2>
                                        {searchResults.length === 0 ? (
                                            <div className="py-20 text-center text-gray-500 font-bold">{t.no_data || 'No results found.'}</div>
                                        ) : (
                                            <>
                                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">
                                                    {searchResults.slice(0, searchLimit).map((w, idx) => (
                                                        <WebtoonCard key={w.id} item={w} rank={0} onDislike={toggleDislike} onLike={toggleLike} onExcludeFromResult={excludeFromResult} isLiked={likedIds.includes(w.id)} isDisliked={dislikedIds.includes(w.id)} t={t} />
                                                    ))}
                                                </div>
                                                {searchResults.length > searchLimit && (
                                                    <div className="mt-12 flex justify-center">
                                                        <button
                                                            onClick={() => setSearchLimit(prev => prev + 10)}
                                                            className="group flex flex-col items-center gap-2 text-gray-500 hover:text-primary transition-all"
                                                        >
                                                            <span className="text-sm font-bold uppercase tracking-widest">{lang === 'ko' ? '검색 결과 더보기' : 'Show More'}</span>
                                                            <div className="w-12 h-12 rounded-full border-2 border-white/10 flex items-center justify-center group-hover:border-primary group-hover:bg-primary/5 transition-all">
                                                                <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current group-hover:animate-bounce mt-1"><path d="M7 10l5 5 5-5z"></path></svg>
                                                            </div>
                                                        </button>
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                </div>
                            )
                        }

                        {
                            view === 'worldcup' && (
                                <div className="animate-up">
                                    <div className="max-w-4xl mx-auto -mt-6 md:-mt-10">
                                        <WorldcupModal
                                            isOpen={true}
                                            onClose={() => setView('home')}
                                            t={t}
                                            user={user}
                                            onSaveResult={(result) => setWorldcupHistory(prev => [result, ...prev])}
                                            isViewMode={true}
                                        />
                                    </div>
                                </div>
                            )
                        }

                        {
                            view === 'recommend' && (
                                <>
                                    <ProgressBar step={step} t={t} />
                                    {step === 1 && (
                                        <div className="animate-up max-w-4xl mx-auto">
                                            <div className="text-center mb-12">
                                                <h2 className="text-3xl sm:text-4xl font-black mb-4 tracking-tight text-white">{t.step1_title}</h2>
                                                <p className="text-gray-500 font-medium">{t.step1_desc}</p>
                                            </div>
                                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                                                {[
                                                    { k: '판타지', t: t.g_fantasy, img: '1.jpg' },
                                                    { k: '로맨스', t: t.g_romance, img: '5.jpg' },
                                                    { k: '액션', t: t.g_action, img: '2.jpg' },
                                                    { k: '일상', t: t.g_daily, img: '4.jpg' },
                                                    { k: '스릴러', t: t.g_thriller, img: '6.jpg' },
                                                    { k: '무협', t: t.g_martial, img: '7.jpg' }
                                                ].map(item => (
                                                    <button
                                                        key={item.k}
                                                        onClick={() => setSelectedG(prev => prev.includes(item.k) ? prev.filter(it => it !== item.k) : [...prev, item.k])}
                                                        className={`relative overflow-hidden rounded-2xl aspect-[2/3] transition-all ${selectedG.includes(item.k) ? 'ring-4 ring-primary shadow-lg scale-[0.98]' : 'hover:scale-[1.02] hover:shadow-md'}`}
                                                    >
                                                        <img src={item.img} alt={item.k} className="w-full h-full object-cover" referrerPolicy="no-referrer" />
                                                        <div className="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors"></div>
                                                        <div className="absolute inset-0 flex items-center justify-center p-2 text-center">
                                                            <span className="text-white font-black text-sm drop-shadow-lg break-keep bg-black/50 backdrop-blur-sm px-2.5 py-0.5 rounded-lg">{item.t}</span>
                                                        </div>
                                                        {selectedG.includes(item.k) && (
                                                            <div className="absolute top-3 right-3 bg-primary text-white w-6 h-6 flex items-center justify-center rounded-full shadow-lg border-2 border-white">
                                                                <span className="text-xs font-bold">✓</span>
                                                            </div>
                                                        )}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="mt-16 text-center">
                                                <button disabled={selectedG.length === 0} onClick={nextStep} className="w-full sm:w-auto px-16 py-5 btn-gradient text-[#334155] font-bold rounded-full disabled:opacity-20 text-lg uppercase tracking-widest">{t.next}</button>
                                            </div>
                                        </div>
                                    )}
                                    {step === 2 && (
                                        <div className="animate-up max-w-3xl mx-auto">
                                            <div className="text-center mb-12">
                                                <h2 className="text-3xl sm:text-4xl font-black mb-4 tracking-tight text-white">{t.step2_title}</h2>
                                                <p className="text-gray-500 font-medium">{t.step2_desc}</p>
                                            </div>
                                            <div className="space-y-8">
                                                <div>
                                                    <h3 className="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4">연재여부</h3>
                                                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                                        {[
                                                            { k: '연재중', t: t.t_ongoing || '연재중' },
                                                            { k: '매일+', t: t.t_dailyplus || '매일+' },
                                                            { k: '완결', t: t.t_finished || '완결' }
                                                        ].map(item => (
                                                            <button
                                                                key={item.k}
                                                                onClick={() => setExcludedG(prev => prev.includes(item.k) ? prev.filter(it => it !== item.k) : [...prev, item.k])}
                                                                className={`py-4 px-6 rounded-xl text-sm font-bold border-2 transition-all ${excludedG.includes(item.k) ? 'bg-red-500 border-red-500 text-white shadow-md scale-[0.98]' : 'bg-white/5 border-white/10 text-gray-400 hover:border-red-500/50 hover:text-red-500'}`}
                                                            >
                                                                {item.t}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 className="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4">소재</h3>
                                                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                                        {[
                                                            { k: '회귀', t: t.t_regress || '회귀' },
                                                            { k: '먼치킨', t: t.t_op || '먼치킨' },
                                                            { k: '환생', t: t.t_reborn || '환생' },
                                                            { k: '빙의', t: t.t_possess || '빙의' },
                                                            { k: '사이다', t: t.t_cidar || '사이다' }
                                                        ].map(item => (
                                                            <button
                                                                key={item.k}
                                                                onClick={() => setExcludedG(prev => prev.includes(item.k) ? prev.filter(it => it !== item.k) : [...prev, item.k])}
                                                                className={`py-4 px-6 rounded-xl text-sm font-bold border-2 transition-all ${excludedG.includes(item.k) ? 'bg-red-500 border-red-500 text-white shadow-md scale-[0.98]' : 'bg-white/5 border-white/10 text-gray-400 hover:border-red-500/50 hover:text-red-500'}`}
                                                            >
                                                                #{item.t}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 className="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4">{lang === 'ko' ? '직접 입력 (태그/키워드)' : 'Manual Input (Tag/Keyword)'}</h3>
                                                    <div className="relative">
                                                        <input
                                                            type="text"
                                                            value={manualExcludes}
                                                            onChange={e => setManualExcludes(e.target.value)}
                                                            placeholder={lang === 'ko' ? '예: 사이다, 피폐, 참교육 (쉼표로 구분)' : 'Ex: Clover, Dark, Revenge (split with comma)'}
                                                            className="w-full py-5 px-8 rounded-2xl bg-white/5 border-2 border-white/10 focus:border-red-500/50 outline-none text-white placeholder:text-gray-600 transition-all font-medium"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="mt-16 flex gap-4 justify-center">
                                                <button onClick={prevStep} className="px-12 py-4 bg-white/5 border border-white/10 text-gray-400 font-bold rounded-full uppercase hover:border-white/30 transition-all">{t.back}</button>
                                                <button onClick={nextStep} className="px-12 py-4 btn-gradient text-[#334155] font-bold rounded-full uppercase">{t.continue}</button>
                                            </div>
                                        </div>
                                    )}
                                    {step === 3 && (
                                        <div className="animate-up max-w-2xl mx-auto py-10 px-6">
                                            <div className="text-center mb-12">
                                                <h2 className="text-3xl font-black mb-4 tracking-tight text-white">{t.step3_title}</h2>
                                                <p className="text-gray-400 font-medium italic opacity-80 decoration-primary/30 decoration-2">{t.step3_desc || ""}</p>
                                            </div>
                                            <div className="space-y-8">
                                                <input
                                                    type="text"
                                                    value={favTitle}
                                                    onChange={e => setFavTitle(e.target.value)}
                                                    placeholder={t.step3_placeholder}
                                                    className="w-full py-5 px-8 rounded-2xl bg-white/5 border-2 border-white/10 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-center text-lg transition-all font-medium text-white placeholder:text-gray-600 shadow-inner"
                                                />
                                                <div className="flex gap-3">
                                                    <button onClick={prevStep} className="flex-1 py-4 bg-white/5 border border-white/10 text-gray-400 font-bold rounded-2xl hover:border-white/30 transition-all uppercase tracking-widest text-sm">{t.back}</button>
                                                    <button
                                                        onClick={handleAnalyze}
                                                        className="flex-[2] py-4 btn-gradient text-[#334155] font-bold rounded-2xl hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest"
                                                    >
                                                        {t.start_analysis}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {step === 4 && (
                                        <div className="animate-up">{loading ? (<div className="flex flex-col items-center justify-center py-40"><div className="w-16 h-16 border-[6px] border-white/10 border-t-primary rounded-full animate-spin mb-10"></div><p className="text-gray-400 font-bold tracking-widest uppercase animate-pulse">{t.computing}</p></div>) : (<div className="animate-up max-w-[1400px] mx-auto pb-40 px-0 md:px-6"><div className="text-center mb-14"><h2 className="text-2xl sm:text-3xl font-black mb-3 tracking-tight text-white">{t.result_title}</h2><p className="text-gray-500 font-medium text-sm">{t.result_desc}</p></div><div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">{results.map((w, idx) => (<WebtoonCard key={w.id} item={w} rank={idx + 1} onDislike={toggleDislike} onLike={toggleLike} onExcludeFromResult={excludeFromResult} isLiked={likedIds.includes(w.id)} isDisliked={dislikedIds.includes(w.id)} t={t} />))}</div><button onClick={reset} className="mt-20 px-12 py-5 border-2 border-white/10 text-gray-400 font-bold rounded-full hover:border-primary hover:text-primary transition-all uppercase block mx-auto tracking-widest text-sm">NEW SEARCH</button></div>)}</div>
                                    )}
                                </>
                            )
                        }
                    </main >
                    {/* Random Pick Floating Refresh Button (Mobile) - REMOVED since we have bottom nav */}
                    {showExcludePopup && (<div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[1000] animate-up"><div className="bg-gray-900/95 backdrop-blur-md text-white px-8 py-4 rounded-3xl shadow-2xl flex items-center gap-3"><span className="text-2xl">🚫</span><p className="font-bold text-sm tracking-tight">{t.exclude_msg}</p></div></div>)}

                    {/* Conflict Confirmation Modal */}
                    {
                        conflictTag && (
                            <div className="modal-container" onClick={() => setConflictTag(null)}>
                                <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                                    <div className="bg-[#161B28] w-full max-w-xs rounded-[40px] shadow-2xl p-8 text-center animate-up border border-white/10">
                                        <span className="text-3xl mb-4 block">⚠️</span>
                                        <p className="text-white font-bold text-sm leading-relaxed mb-8 whitespace-pre-wrap">{t.conflict_msg}</p>
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => {
                                                    setSelectedG(prev => prev.filter(it => it !== conflictTag));
                                                    setExcludedG(prev => [...prev, conflictTag]);
                                                    setConflictTag(null);
                                                }}
                                                className="flex-1 py-4 bg-primary text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform"
                                            >
                                                {t.yes}
                                            </button>
                                            <button
                                                onClick={() => setConflictTag(null)}
                                                className="flex-1 py-4 bg-white/5 text-gray-400 font-bold rounded-2xl active:scale-95 transition-transform"
                                            >
                                                {t.no}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {/* Mobile Bottom Navigation */}
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-[#0B0F1A]/95 backdrop-blur-xl border-t border-white/5 z-[10000] pb-safe px-6 py-2 flex justify-between items-center text-[10px] font-medium text-gray-400">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 p-2 ${view === 'home' ? 'text-primary' : 'hover:text-white'}`}>
                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg>
                            홈
                        </button>
                        <button onClick={() => { setView('recommend'); setStep(1); }} className={`flex flex-col items-center gap-1 p-2 ${view === 'recommend' ? 'text-primary' : 'hover:text-white'}`}>
                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current"><path d="M9.5 13.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" /></svg>
                            AI추천
                        </button>
                        <button onClick={() => setView('random')} className={`flex flex-col items-center gap-1 p-2 ${view === 'random' ? 'text-primary' : 'hover:text-white'}`}>
                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-none stroke-current stroke-2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"></circle><circle cx="15.5" cy="15.5" r="1.5" fill="currentColor"></circle><circle cx="15.5" cy="8.5" r="1.5" fill="currentColor"></circle><circle cx="8.5" cy="15.5" r="1.5" fill="currentColor"></circle><circle cx="12" cy="12" r="1.5" fill="currentColor"></circle></svg>
                            랜덤
                        </button>
                        <button onClick={() => setView('worldcup')} className={`flex flex-col items-center gap-1 p-2 ${view === 'worldcup' ? 'text-primary' : 'hover:text-white'}`}>
                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-none stroke-current stroke-2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
                            토너먼트
                        </button>
                        <button onClick={() => setView('search')} className={`flex flex-col items-center gap-1 p-2 ${view === 'search' ? 'text-primary' : 'hover:text-white'}`}>
                            <svg viewBox="0 0 24 24" className="w-6 h-6 fill-current"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                            검색
                        </button>
                    </div>

                    <ShareModal isOpen={showShareModal} onClose={() => setShowShareModal(false)} t={t} results={profileTab === 'liked' ? likedIds.map(id => (window.WEBTOON_DATA || MOCK_WEBTOONS).find(w => (w.titleId || w.id) == id)).filter(Boolean) : results} />
                    <HelpModal isOpen={showHelpModal} onClose={() => setShowHelpModal(false)} t={t} />

                    {
                        showWorldcupModal && (
                            <div className="modal-container" onClick={() => setShowWorldcupModal(false)}>
                                <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                                    <WorldcupModal
                                        isOpen={showWorldcupModal}
                                        onClose={() => setShowWorldcupModal(false)}
                                        t={t}
                                        user={user}
                                        onSaveResult={(result) => setWorldcupHistory(prev => [result, ...prev])}
                                    />
                                </div>
                            </div>
                        )
                    }

                    {/* Authentication Modal */}
                    {/* Authentication Modal */}
                    {
                        showAuthModal && (
                            <div className="modal-container" onClick={() => { setShowAuthModal(false); setAuthMode('login'); setEmail(''); setPassword(''); setConfirmPassword(''); }}>
                                <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                                    <div className="bg-[#161B28] w-full max-w-sm rounded-[48px] shadow-2xl p-10 flex flex-col items-center border border-white/10">
                                        <h3 className="text-2xl font-black mb-8 tracking-tighter text-white">{authMode === 'login' ? t.login : t.signup_btn}</h3>
                                        <div className="w-full space-y-4">
                                            <div className="flex flex-col gap-3">
                                                <input
                                                    type="email"
                                                    value={email}
                                                    onChange={e => setEmail(e.target.value)}
                                                    placeholder={t.email}
                                                    className="px-6 py-4 rounded-2xl bg-white/5 border border-white/10 outline-none focus:border-primary font-bold text-sm text-white placeholder:text-gray-500"
                                                />
                                                <input
                                                    type="password"
                                                    value={password}
                                                    onChange={e => setPassword(e.target.value)}
                                                    placeholder={t.password}
                                                    className="px-6 py-4 rounded-2xl bg-white/5 border border-white/10 outline-none focus:border-primary font-bold text-sm text-white placeholder:text-gray-500"
                                                />
                                                {authMode === 'signup' && (
                                                    <>
                                                        <input
                                                            type="password"
                                                            value={confirmPassword}
                                                            onChange={e => setConfirmPassword(e.target.value)}
                                                            placeholder={t.password_confirm}
                                                            className="px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 outline-none focus:border-primary font-bold text-sm"
                                                        />
                                                        {password && password.length < 6 && <p className="text-[10px] font-bold text-red-500 px-2">{t.pw_criteria}</p>}
                                                        {confirmPassword && password !== confirmPassword && <p className="text-[10px] font-bold text-red-500 px-2">{t.pw_mismatch}</p>}
                                                    </>
                                                )}
                                            </div>

                                            {authMode === 'login' ? (
                                                <div className="flex flex-col gap-4">
                                                    <button
                                                        onClick={async () => {
                                                            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                                                            if (error) alert(t.login_error_msg || error.message); else setShowAuthModal(false);
                                                        }}
                                                        className="w-full py-4 bg-primary text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform"
                                                    >
                                                        {t.login_btn}
                                                    </button>
                                                    <button
                                                        onClick={() => setAuthMode('signup')}
                                                        className="text-center text-[11px] font-bold text-gray-400 hover:text-primary transition-colors"
                                                    >
                                                        {t.go_to_signup}
                                                    </button>
                                                    <button
                                                        onClick={async () => {
                                                            if (!email) { alert("Please enter your email first"); return; }
                                                            const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
                                                            if (error) alert(error.message); else alert(t.reset_pw_msg);
                                                        }}
                                                        className="w-full text-center text-[11px] font-bold text-gray-400 hover:text-primary transition-colors pt-2 border-t border-gray-50 mt-2"
                                                    >
                                                        {t.find_pw}
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="flex flex-col gap-4">
                                                    <button
                                                        disabled={!email || password.length < 6 || password !== confirmPassword}
                                                        onClick={async () => {
                                                            const { error } = await supabaseClient.auth.signUp({ email, password });
                                                            if (error) alert(error.message);
                                                            else {
                                                                alert(t.signup_confirm_msg);
                                                                setAuthMode('login');
                                                            }
                                                        }}
                                                        className="w-full py-4 bg-primary text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform disabled:opacity-30 disabled:pointer-events-none"
                                                    >
                                                        {t.signup_btn}
                                                    </button>
                                                    <button
                                                        onClick={() => setAuthMode('login')}
                                                        className="text-center text-[11px] font-bold text-gray-400 hover:text-primary transition-colors"
                                                    >
                                                        {t.go_to_login}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => { setShowAuthModal(false); setAuthMode('login'); setEmail(''); setPassword(''); setConfirmPassword(''); }}
                                            className="mt-8 text-gray-400 font-bold text-xs uppercase"
                                        >
                                            CLOSE
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {/* My Info Modal */}
                    {
                        showProfileModal && (
                            <div className="modal-container" onClick={() => setShowProfileModal(false)}>
                                <div className="modal-content-box" onClick={e => e.stopPropagation()}>
                                    <div className="bg-[#161B28] w-full max-w-2xl rounded-[48px] shadow-2xl flex flex-col h-[80vh] border border-white/10 overflow-hidden">
                                        <div className="p-10 pb-6 flex flex-col items-center flex-shrink-0">
                                            <h3 className="text-2xl font-black mb-6 tracking-tighter text-white">{t.my_info}</h3>
                                            <div className="flex gap-2 p-1.5 bg-white/5 rounded-2xl w-full">
                                                <button onClick={() => setProfileTab('liked')} className={`flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all h-full ${profileTab === 'liked' ? 'bg-white/10 text-primary shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}>📚 {lang === 'ko' ? '나의 컬렉션' : 'My Collection'}</button>
                                                <button onClick={() => setProfileTab('excluded')} className={`flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all h-full whitespace-pre-wrap leading-tight ${profileTab === 'excluded' ? 'bg-white/10 text-red-500 shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}>{t.excluded_list === '비선호 작품 (싫어요)' ? <>비선호작품<br />(싫어요)</> : t.excluded_list}</button>
                                                <button onClick={() => setProfileTab('worldcup')} className={`flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all h-full whitespace-pre-wrap leading-tight ${profileTab === 'worldcup' ? 'bg-white/10 text-yellow-600 shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}>🏆 {t.worldcup_history === '토너먼트 기록' ? <>토너먼트<br />기록</> : t.worldcup_history}</button>
                                            </div>
                                        </div>
                                        <div className="flex-grow overflow-y-auto px-10 no-scrollbar">
                                            {profileTab === 'liked' && (
                                                <div className="mb-6">
                                                    <button onClick={() => setShowShareModal(true)} className="w-full py-4 bg-primary/10 text-primary font-black rounded-2xl hover:bg-primary/20 transition-all flex items-center justify-center gap-2">
                                                        <span>🔗</span> 컬렉션 공유하기
                                                    </button>
                                                </div>
                                            )}
                                            {profileTab === 'worldcup' ? (
                                                <div className="space-y-4 pb-10">
                                                    {worldcupHistory.length === 0 ? (
                                                        <div className="py-20 text-center text-gray-300 font-bold">{t.no_data}</div>
                                                    ) : (
                                                        worldcupHistory.map((record, idx) => {
                                                            const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                                                            const w = rawData.find(it => (it.titleId || it.id) == record.winner_id);
                                                            return (
                                                                <div key={idx} className="flex gap-4 p-4 rounded-[28px] border border-white/5 bg-white/5 hover:bg-white/10 transition-all">
                                                                    {w && (
                                                                        <>
                                                                            <div className="w-16 h-20 rounded-xl overflow-hidden flex-shrink-0 bg-white/5">
                                                                                <img src={w.thumbnailUrl || w.thumbnail} referrerPolicy="no-referrer" className="w-full h-full object-cover" />
                                                                            </div>
                                                                            <div className="flex flex-col justify-center min-w-0 flex-grow">
                                                                                <h4 className="font-extrabold text-white text-sm truncate tracking-tight">{record.winner_title}</h4>
                                                                                <p className="text-[10px] font-bold text-yellow-600 uppercase mt-1">🏆 {record.round}{t.worldcup_round} {t.worldcup_winner}</p>
                                                                                <p className="text-[9px] text-gray-400 mt-1">{new Date(record.created_at).toLocaleDateString()}</p>
                                                                            </div>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-10">
                                                    {(profileTab === 'liked' ? likedIds : dislikedIds).length === 0 ? (
                                                        <div className="col-span-full py-20 text-center text-gray-300 font-bold">{t.no_data}</div>
                                                    ) : (
                                                        (profileTab === 'liked' ? likedIds : dislikedIds).map(id => {
                                                            const rawData = window.WEBTOON_DATA || MOCK_WEBTOONS;
                                                            const w = rawData.find(it => (it.titleId || it.id) == id);
                                                            if (!w) return null;
                                                            const isExcludedFromReco = excludedFromRecoIds.includes(id);
                                                            return (
                                                                <div key={id} className="flex flex-col gap-3 p-4 rounded-[28px] border border-white/5 bg-white/5 hover:bg-white/10 transition-all group">
                                                                    <div className="flex gap-4">
                                                                        <div className="w-16 h-20 rounded-xl overflow-hidden flex-shrink-0 bg-gray-100">
                                                                            <img src={w.thumbnailUrl || w.thumbnail} referrerPolicy="no-referrer" className="w-full h-full object-cover" />
                                                                        </div>
                                                                        <div className="flex flex-col justify-center min-w-0 flex-grow">
                                                                            <h4 className="font-extrabold text-white text-sm truncate tracking-tight">{w.titleName || w.title}</h4>
                                                                            <p className="text-[10px] font-bold text-gray-400 uppercase mt-1">{(w.tags || []).slice(0, 2).join(' ')}</p>
                                                                        </div>
                                                                        <button
                                                                            onClick={async () => {
                                                                                if (profileTab === 'liked') {
                                                                                    await supabaseClient.from('favorite_webtoons').delete().eq('user_id', user.id).eq('webtoon_id', id);
                                                                                    setLikedIds(prev => prev.filter(it => it !== id));
                                                                                } else {
                                                                                    await supabaseClient.from('excluded_webtoons').delete().eq('user_id', user.id).eq('webtoon_id', id);
                                                                                    setDislikedIds(prev => prev.filter(it => it !== id));
                                                                                }
                                                                            }}
                                                                            className="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-white text-gray-300 hover:text-red-500 shadow-sm transition-all"
                                                                        >
                                                                            <svg viewBox="0 0 24 24" className="w-4 h-4 fill-current"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                                                                        </button>
                                                                    </div>
                                                                    <div className="flex items-center justify-between px-2 pt-2 border-t border-white/5">
                                                                        <label className="flex items-center gap-2 cursor-pointer group/toggle">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={isExcludedFromReco}
                                                                                onChange={async (e) => {
                                                                                    const checked = e.target.checked;
                                                                                    if (checked) {
                                                                                        await supabaseClient.from('excluded_from_recommendations').insert({ user_id: user.id, webtoon_id: id });
                                                                                        setExcludedFromRecoIds(prev => [...prev, id]);
                                                                                    } else {
                                                                                        await supabaseClient.from('excluded_from_recommendations').delete().eq('user_id', user.id).eq('webtoon_id', id);
                                                                                        setExcludedFromRecoIds(prev => prev.filter(it => it !== id));
                                                                                    }
                                                                                }}
                                                                                className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"
                                                                            />
                                                                            <span className="text-[10px] font-bold text-gray-500 group-hover/toggle:text-gray-700">{t.exclude_from_reco}</span>
                                                                        </label>
                                                                        <span className="text-[9px] text-gray-400">{t.exclude_from_reco_desc}</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        <div className="p-10 pt-6 border-t border-white/5 flex flex-col gap-4 flex-shrink-0">
                                            <button
                                                onClick={async () => {
                                                    if (confirm(t.delete_confirm)) {
                                                        await supabaseClient.from('favorite_webtoons').delete().eq('user_id', user.id);
                                                        await supabaseClient.from('excluded_webtoons').delete().eq('user_id', user.id);
                                                        await supabaseClient.auth.signOut();
                                                        alert("All data cleared. Your account is now inactive.");
                                                        setShowProfileModal(false);
                                                    }
                                                }}
                                                className="text-[11px] font-bold text-gray-500 hover:text-red-400 transition-colors self-center uppercase border-b border-white/10"
                                            >
                                                {t.delete_account}
                                            </button>
                                            <button onClick={() => setShowProfileModal(false)} className="w-full py-5 bg-white/5 rounded-2xl text-gray-500 font-black uppercase hover:text-gray-300 transition-colors">CLOSE</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {/* Footer with Visitor Counter */}
                    <footer className="fixed bottom-0 left-0 right-0 bg-[#0B0F1A]/90 backdrop-blur-md border-t border-white/5 py-3 px-4 z-[900]">
                        <div className="max-w-7xl mx-auto flex items-center justify-center gap-6">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">{t.today_visitors}</span>
                                <span className="text-sm font-bold text-primary">{todayVisitors.toLocaleString()}</span>
                            </div>
                            <div className="w-px h-4 bg-white/10"></div>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">{t.total_visitors}</span>
                                <span className="text-sm font-bold text-gray-400">{totalVisitors.toLocaleString()}</span>
                            </div>
                        </div>
                    </footer>
                </div >
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>

</html>